<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>eHalalGAP</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    body {
      font-family: 'Inter', sans-serif;
    }
    /* Gaya untuk ikon Facebook terapung */
    .floating-facebook-icon {
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 50; /* Pastikan ia berada di atas elemen lain */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s;
    }
    .floating-facebook-icon:hover {
        transform: scale(1.1);
    }
  </style>
</head>
<body class="min-h-screen bg-slate-100 antialiased text-slate-800 flex flex-col items-center p-4 sm:p-6">

  <!-- Main Application Container -->
  <main id="app-container" class="max-w-7xl w-full mx-auto">
    <!-- Navigation (Visible after login) -->
    <div id="nav-bar" class="flex justify-between items-center mb-6 hidden">
      <div class="flex-grow"></div>
      <div class="flex items-center space-x-2 flex-wrap justify-end">
        <button id="nav-home" class="nav-button px-2 py-1 sm:px-4 sm:py-2 rounded-lg font-medium transition-colors duration-200 text-slate-700 hover:bg-slate-200">Utama</button>
        <div id="client-nav-buttons" class="hidden flex items-center space-x-2">
          <button id="nav-checklist" class="nav-button px-2 py-1 sm:px-4 sm:py-2 rounded-lg font-medium transition-colors duration-200 text-slate-700 hover:bg-slate-200">Senarai Semak</button>
          <button id="nav-profile" class="nav-button px-2 py-1 sm:px-4 sm:py-2 rounded-lg font-medium transition-colors duration-200 text-slate-700 hover:bg-slate-200">Profil Saya</button>
        </div>
        <div id="consultant-nav-buttons" class="hidden flex items-center space-x-2">
          <button id="nav-consultant-dashboard" class="nav-button px-2 py-1 sm:px-4 sm:py-2 rounded-lg font-medium transition-colors duration-200 text-slate-700 hover:bg-slate-200">Papan Pemuka</button>
          <button id="nav-consultant-client" class="nav-button px-2 py-1 sm:px-4 sm:py-2 rounded-lg font-medium transition-colors duration-200 text-slate-700 hover:bg-slate-200 hidden">Profil Klien</button>
        </div>
        <button id="logout-button" class="px-2 py-1 sm:px-4 sm:py-2 rounded-lg bg-rose-600 text-white font-medium hover:bg-rose-700 transition-colors duration-200">
          Log Keluar
        </button>
      </div>
    </div>

    <!-- Page Containers -->
    <div id="page-landing" class="page-container"></div>
    <div id="page-login" class="page-container hidden"></div>
    <div id="page-home" class="page-container hidden"></div>
    <div id="page-checklist" class="page-container hidden"></div>
    <div id="page-profile" class="page-container hidden"></div>
    <div id="page-consultant-dashboard" class="page-container hidden"></div>
    <div id="page-consultant-client" class="page-container hidden"></div>
  </main>

  <!-- Ikon Facebook Terapung -->
  <a href="https://www.facebook.com/p/ACE-UniKL-MICET-61554554881822/" target="_blank" rel="noopener noreferrer" class="floating-facebook-icon bg-white rounded-full p-3 hover:bg-blue-600">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512" class="w-6 h-6 text-blue-600 hover:text-white" fill="currentColor">
        <!-- Font Awesome Free 6.5.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2024 Fonticons, Inc. -->
        <path d="M400 32H48A48 48 0 0 0 0 80v352a48 48 0 0 0 48 48h137V328h-38v-43h38v-29.5c0-37.3 21.6-58.4 56.4-58.4 16.9 0 34.6 3 34.6 3v36h-23.7c-18.7 0-22.5 11.7-22.5 22v26.5h41.5l-6.6 43h-35v132h145A48 48 0 0 0 448 432V80a48 48 0 0 0-48-48z"/>
    </svg>
  </a>


  <footer class="mt-12 text-xs text-slate-500 text-center">
    Hak Cipta oleh ACE UniKL MICET 2025
  </footer>

  <!-- Modal Structure -->
  <div id="modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 invisible transition-opacity duration-300">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full transform scale-95 transition-transform duration-300">
      <div class="flex justify-between items-center">
        <h3 id="modal-title" class="text-2xl font-bold text-slate-800"></h3>
        <button id="modal-close-btn" class="text-slate-400 hover:text-slate-600 transition-colors duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <p id="modal-message" class="mt-4 text-slate-600"></p>
      <div id="upload-progress-container" class="mt-4 hidden">
        <div class="w-full bg-slate-200 rounded-full h-2.5">
          <div id="upload-progress-bar" class="bg-indigo-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
        </div>
        <div class="text-right text-xs text-slate-500 mt-1"><span id="upload-progress-text">0%</span> dimuat naik</div>
      </div>
      <div class="mt-8 text-right">
        <button id="modal-ok-btn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200">Tutup</button>
      </div>
    </div>
  </div>
  
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut, createUserWithEmailAndPassword, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, getDoc, setLogLevel, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";

    // Global state variables
    let page = 'landing';
    let checklist = [];
    let clientData = null;
    let userId = null;
    let isConsultant = false;
    let selectedClientId = null;
    let clients = [];
    let unsubscribeClientListener = null;
    let unsubscribeConsultantListener = null;
    let isAuthReady = false;
    
    // Global Firebase instances
    let app, auth, db, storage;

    // --- PASTE YOUR FIREBASE CONFIGURATION HERE ---
    // You MUST replace this with your project's Firebase configuration.
    // Get it from Firebase Console > Project settings.
    const firebaseConfig = {
      apiKey: "AIzaSyAiIniIt-7Kk1tB9F20l7qXLwAmKF07DSU",
      authDomain: "hecera-app.firebaseapp.com",
      projectId: "hecera-app",
      storageBucket: "hecera-app.firebasestorage.app",
      messagingSenderId: "951898649821",
      appId: "1:951898649821:web:48eeeea0c51144963a9734",
      measurementId: "G-D3X4N3MKDD"
    };
    const appId = firebaseConfig.projectId; // Or a custom ID if you prefer
    
    // Initialize Firebase App, Auth, and Firestore instances once
    if (Object.keys(firebaseConfig).length > 0 && firebaseConfig.apiKey !== "YOUR_API_KEY") {
      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        storage = getStorage(app);
        setLogLevel('debug');
      } catch (e) {
        console.error("Firebase initialization failed:", e);
      }
    } else {
        console.error("Firebase configuration is missing or invalid. Please update the firebaseConfig object in the code.");
    }
    
    const PUBLIC_DATA_PATH = `artifacts/${appId}/public/data/clients`;
    const PRIVATE_DATA_PATH = (uid) => `artifacts/${appId}/users/${uid}/clientData`;
    const USERS_COLLECTION = `users`;

    const SAMPLE_CHECKLIST = [
      { id: 1, category: 'Dokumentasi', title: 'Sijil pendaftaran syarikat (SSM)', required: true, done: false, sampleLink: 'https://example.com/sample-docs/ssm.pdf', comment: '', fileUrl: '' },
      { id: 2, category: 'Dokumentasi', title: 'Lesen perniagaan/pembuatan', required: true, done: false, sampleLink: 'https://example.com/sample-docs/license.pdf', comment: '', fileUrl: '' },
      { id: 3, category: 'Dokumentasi', title: 'Senarai semua produk/perkhidmatan', required: true, done: false, sampleLink: 'https://example.com/sample-docs/products.pdf', comment: '', fileUrl: '' },
      { id: 4, category: 'Dokumentasi', title: 'Senarai lengkap semua bahan', required: true, done: false, sampleLink: 'https://example.com/sample-docs/ingredients.pdf', comment: '', fileUrl: '' },
      { id: 5, category: 'Dokumentasi', title: 'Sijil Halal untuk semua bahan', required: true, done: false, sampleLink: 'https://example.com/sample-docs/halal-certs.pdf', comment: '', fileUrl: '' },
      { id: 6, category: 'Dokumentasi', title: 'Helaian spesifikasi bahan', required: false, done: false, sampleLink: 'https://example.com/sample-docs/specs.pdf', comment: '', fileUrl: '' },
      { id: 7, category: 'Dokumentasi', title: 'Carta aliran proses untuk setiap produk', required: true, done: false, sampleLink: 'https://example.com/sample-docs/flow-chart.pdf', comment: '', fileUrl: '' },
      { id: 8, category: 'Dokumentasi', title: 'Pelan susun atur kilang dan peta lokasi', required: true, done: false, sampleLink: 'https://example.com/sample-docs/layout.pdf', comment: '', fileUrl: '' },
      { id: 9, category: 'Dokumentasi', title: 'Foto tapak pembuatan', required: true, done: false, sampleLink: 'https://example.com/sample-docs/photos.pdf', comment: '', fileUrl: '' },
      { id: 10, category: 'Dokumentasi', title: 'Reka bentuk pembungkusan dan label produk', required: true, done: false, sampleLink: 'https://example.com/sample-docs/labels.pdf', comment: '', fileUrl: '' },
      { id: 11, category: 'Dokumentasi', title: 'Pensijilan jaminan kualiti lain (HACCP, ISO, dsb.)', required: false, done: false, sampleLink: 'https://example.com/sample-docs/certs.pdf', comment: '', fileUrl: '' },
      { id: 12, category: 'Dokumentasi', title: 'Bukti daya maju kewangan (perolehan tahunan)', required: true, done: false, sampleLink: 'https://example.com/sample-docs/turnover.pdf', comment: '', fileUrl: '' },
      { id: 13, category: 'Operasi', title: 'Pengasingan pemprosesan produk Halal', required: true, done: false, sampleLink: 'https://example.com/sample-docs/segregation-plan.pdf', comment: '', fileUrl: '' },
      { id: 14, category: 'Operasi', title: 'Prosedur sanitasi peralatan', required: true, done: false, sampleLink: 'https://example.com/sample-docs/sanitation-sop.pdf', comment: '', fileUrl: '' },
      { id: 15, category: 'Operasi', title: 'Kebersihan dan sanitasi premis (GMP/GHP)', required: true, done: false, sampleLink: 'https://example.com/sample-docs/hygiene-plan.pdf', comment: '', fileUrl: '' },
      { id: 16, category: 'Operasi', title: 'Perniagaan telah beroperasi sekurang-kurangnya 3 bulan', required: true, done: false, sampleLink: 'https://example.com/sample-docs/3-months-operation.pdf', comment: '', fileUrl: '' },
      { id: 17, category: 'Personel', title: 'Sekurang-kurangnya dua pekerja Muslim sepenuh masa', required: true, done: false, sampleLink: 'https://example.com/sample-docs/employee-records.pdf', comment: '', fileUrl: '' },
      { id: 18, category: 'Personel', title: 'Eksekutif Halal Bertauliah (jika berkenaan)', required: true, done: false, sampleLink: 'https://example.com/sample-docs/halal-exec-cert.pdf', comment: '', fileUrl: '' },
      { id: 19, category: 'Personel', title: 'Manual Sistem Jaminan Halal (HAS)', required: true, done: false, sampleLink: 'https://example.com/sample-docs/has-manual.pdf', comment: '', fileUrl: '' },
      { id: 20, category: 'Personel', title: 'Latihan kakitangan mengenai prinsip Halal', required: true, done: false, sampleLink: 'https://example.com/sample-docs/training-records.pdf', comment: '', fileUrl: '' }
    ];
    
    // Auth state listener
    if(auth) {
        onAuthStateChanged(auth, async (user) => {
            isAuthReady = true;
            if (user) {
                userId = user.uid;
                try {
                    const userDocRef = doc(db, USERS_COLLECTION, userId);
                    const userDocSnap = await getDoc(userDocRef);
                    if (userDocSnap.exists()) {
                        const userRole = userDocSnap.data().role;
                        // isConsultant set to false to enforce client-only flow on index.html
                        isConsultant = (userRole === 'consultant'); 
                    } else {
                        await setDoc(userDocRef, {
                            email: user.email,
                            role: 'client'
                        });
                        isConsultant = false;
                    }
                    
                    if (!isConsultant) {
                        const clientDocRef = doc(db, PRIVATE_DATA_PATH(userId), 'profile');
                        const publicDocRef = doc(db, PUBLIC_DATA_PATH, userId);
                        const docSnap = await getDoc(clientDocRef);
                        if (!docSnap.exists()) {
                            await setDoc(clientDocRef, {
                                profile: { companyName: '', companyType: '', contactName: '', contactEmail: '', contactPhone: '' },
                                assessment: SAMPLE_CHECKLIST,
                                progress: 0,
                                updated: new Date().toLocaleString()
                            });
                            await setDoc(publicDocRef, {
                              profile: { companyName: '', companyType: '', contactName: '', contactEmail: '', contactPhone: '' },
                              assessment: SAMPLE_CHECKLIST,
                              progress: 0,
                              updated: new Date().toLocaleString()
                            });
                        }

                        if (unsubscribeClientListener) unsubscribeClientListener();
                        unsubscribeClientListener = onSnapshot(clientDocRef, (snap) => {
                          if (snap.exists()) {
                            clientData = snap.data();
                            checklist = clientData.assessment;
                            updateUI();
                          }
                        });
                    } else {
                        // Consultant logic is kept but access to client dashboard is blocked on this page
                        if (unsubscribeConsultantListener) unsubscribeConsultantListener();
                        const publicClientsCollectionRef = collection(db, PUBLIC_DATA_PATH);
                        unsubscribeConsultantListener = onSnapshot(publicClientsCollectionRef, (querySnapshot) => {
                            clients = [];
                            querySnapshot.forEach(docSnap => {
                                const clientData = docSnap.data();
                                clients.push({
                                  id: docSnap.id,
                                  name: clientData.profile?.companyName || `Klien ${docSnap.id.substring(0, 5)}`,
                                  type: clientData.profile?.companyType || 'N/A',
                                  status: clientData.progress === 100 ? 'Sedia' : 'Dalam proses',
                                  progress: clientData.progress || 0,
                                  updated: clientData.updated || 'N/A',
                                  assessment: clientData.assessment || []
                                });
                            });
                            updateUI();
                        }, (error) => {
                          console.error("Error fetching client profiles:", error);
                          // This error is handled by a permission check on the page render
                        });
                    }
                    
                } catch (e) {
                    console.error("Auth state change error:", e);
                    // Handle specific errors like "permission-denied"
                }

                updateUI();
            } else {
                userId = null;
                clientData = null;
                checklist = SAMPLE_CHECKLIST;
                selectedClientId = null;
                if (unsubscribeClientListener) unsubscribeClientListener();
                if (unsubscribeConsultantListener) unsubscribeConsultantListener();
                updateUI();
            }
        });
    }

    // Centralized UI Update Function
    function updateUI() {
        if (!isAuthReady) {
            renderPage('landing');
            return;
        }

        const navBar = document.getElementById('nav-bar');
        const clientNav = document.getElementById('client-nav-buttons');
        const consultantNav = document.getElementById('consultant-nav-buttons');
        const navClientProfile = document.getElementById('nav-consultant-client');

        if (userId) {
            navBar.classList.remove('hidden');
            if (isConsultant) {
                // If consultant logs in through this page, they see the consultant nav, but are redirected in renderPage
                clientNav.classList.add('hidden');
                consultantNav.classList.remove('hidden');
                if (selectedClientId) navClientProfile.classList.remove('hidden');
                else navClientProfile.classList.add('hidden');
            } else {
                clientNav.classList.remove('hidden');
                consultantNav.classList.add('hidden');
            }
        } else {
            navBar.classList.add('hidden');
        }

        renderPage(page);
        attachNavEventListeners();
    }

    function attachNavEventListeners() {
      document.getElementById('nav-home').addEventListener('click', () => {
        renderPage('home');
      });
      document.getElementById('nav-checklist').addEventListener('click', () => {
        renderPage('checklist');
      });
      document.getElementById('nav-profile').addEventListener('click', () => {
        renderPage('profile');
      });
      document.getElementById('nav-consultant-dashboard').addEventListener('click', () => {
        renderPage('consultant');
      });
      document.getElementById('nav-consultant-client').addEventListener('click', () => {
        renderPage('client');
      });
      document.getElementById('logout-button').addEventListener('click', async () => {
        await signOut(auth);
      });
    }

    function renderPage(pageName) {
        page = pageName;
        document.querySelectorAll('.page-container').forEach(el => el.classList.add('hidden'));

        if (userId && isConsultant) {
            // Consultant logged in on the client page -> force redirect or block
            document.getElementById('page-consultant-dashboard').classList.remove('hidden');
            document.getElementById('page-consultant-dashboard').innerHTML = `
                <div class="p-10 bg-white rounded-3xl shadow-xl text-center mt-20">
                    <h2 class="text-3xl font-bold text-rose-600">Akses Ditolak</h2>
                    <p class="mt-4 text-slate-600">Sila gunakan pautan Log Masuk Perunding yang betul untuk mengakses papan pemuka admin.</p>
                    <button onclick="signOut(auth)" class="mt-6 px-6 py-3 bg-rose-600 text-white rounded-lg font-medium hover:bg-rose-700">Log Keluar</button>
                </div>
            `;
            return;
        } 
        
        if (userId && !isConsultant) {
          switch(pageName) {
            case 'checklist':
              document.getElementById('page-checklist').classList.remove('hidden');
              renderChecklistPage();
              break;
            case 'profile':
              document.getElementById('page-profile').classList.remove('hidden');
              renderMyProfilePage();
              break;
            case 'home':
            default:
              document.getElementById('page-home').classList.remove('hidden');
              renderHomePage();
              break;
          }
        } else {
          switch(pageName) {
            case 'login':
              document.getElementById('page-login').classList.remove('hidden');
              renderLoginPage();
              break;
            case 'landing':
            default:
              document.getElementById('page-landing').classList.remove('hidden');
              renderLandingPage();
              break;
          }
        }
        
        document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md'));
        const activeNavButton = document.getElementById(`nav-${pageName.replace('consultant', 'consultant-dashboard').replace('client', 'consultant-client')}`);
        if(activeNavButton) {
          activeNavButton.classList.add('bg-indigo-600', 'text-white', 'shadow-md');
        }
    }

    // Modal functions
    function showModal(title, message, isUpload = false) {
      document.getElementById('modal-title').innerText = title;
      document.getElementById('modal-message').innerText = message;
      document.getElementById('upload-progress-container').classList.add('hidden');
      document.getElementById('modal-ok-btn').classList.remove('hidden');
      
      if (isUpload) {
        document.getElementById('modal-message').classList.add('hidden');
        document.getElementById('upload-progress-container').classList.remove('hidden');
        document.getElementById('modal-ok-btn').classList.add('hidden');
      } else {
        document.getElementById('modal-message').classList.remove('hidden');
      }

      document.getElementById('modal').classList.remove('opacity-0', 'invisible');
      document.querySelector('#modal > div').classList.remove('scale-95');
    }
    function hideModal() {
      document.getElementById('modal').classList.add('opacity-0', 'invisible');
      document.querySelector('#modal > div').classList.add('scale-95');
      document.getElementById('upload-progress-bar').style.width = '0%';
      document.getElementById('upload-progress-text').innerText = '0%';
    }
    document.getElementById('modal-close-btn').addEventListener('click', hideModal);
    document.getElementById('modal-ok-btn').addEventListener('click', hideModal);

    async function handleClientLogin(action) {
      const email = document.getElementById('client-email-input').value;
      const password = document.getElementById('client-password-input').value;

      if (!email || !password) {
        showModal('Log Masuk Gagal', 'Sila masukkan e-mel dan kata laluan.');
        return;
      }

      try {
        if (action === 'signup') {
          await createUserWithEmailAndPassword(auth, email, password);
          await setDoc(doc(db, USERS_COLLECTION, auth.currentUser.uid), {
            email: auth.currentUser.email,
            role: 'client'
          });
          showModal('Pendaftaran Berjaya', 'Akaun anda telah berjaya dicipta. Anda kini log masuk.');
        } else {
          await signInWithEmailAndPassword(auth, email, password);
        }
      } catch (e) {
        let errorMessage = 'Berlaku ralat yang tidak dijangka.';
        if (e.code === 'auth/invalid-credential') {
          errorMessage = 'E-mel atau kata laluan tidak sah. Sila semak semula kelayakan anda.';
        } else if (e.code === 'auth/email-already-in-use') {
          errorMessage = 'E-mel ini sudah digunakan. Sila log masuk atau gunakan e-mel lain.';
        } else {
          errorMessage = `Log masuk gagal: ${e.message}`;
        }
        console.error("Login failed:", e);
        showModal('Log Masuk Gagal', errorMessage);
      }
    }

    async function handlePasswordReset() {
        const email = document.getElementById('client-email-input').value;
        if (!email) {
            showModal('Penetapan Kata Laluan Gagal', 'Sila masukkan alamat e-mel anda untuk menetapkan semula kata laluan.');
            return;
        }
        try {
            await sendPasswordResetEmail(auth, email);
            showModal('E-mel Penetapan Kata Laluan Dihantar', `E-mel telah dihantar ke ${email} dengan arahan untuk menetapkan semula kata laluan anda.`);
        } catch (e) {
            console.error("Password reset failed:", e);
            showModal('Penetapan Kata Laluan Gagal', `Berlaku ralat: ${e.message}`);
        }
    }

    // Page rendering functions
    function renderLandingPage() {
        const landingPageHtml = `
          <header class="w-full flex justify-between items-center py-4 px-6 fixed top-0 left-0 right-0 bg-white bg-opacity-80 backdrop-blur-md z-10">
            <div class="flex items-center space-x-2">
                <div class="font-bold text-xl text-slate-800">eHalalGAP</div>
            </div>
            <nav class="flex space-x-4 items-center">
                <a href="#" class="hidden md:block text-sm font-medium text-slate-600 hover:text-indigo-600 transition-colors">Ciri-ciri</a>
                <a href="#" class="hidden md:block text-sm font-medium text-slate-600 hover:text-indigo-600 transition-colors">Harga</a>
                <a href="#" class="hidden md:block text-sm font-medium text-slate-600 hover:text-indigo-600 transition-colors">Tentang Kami</a>
                <a href="#" class="hidden md:block text-sm font-medium text-slate-600 hover:text-indigo-600 transition-colors">Hubungi</a>
                <button id="get-started-btn-header" class="px-4 py-2 bg-indigo-600 text-white rounded-full font-bold text-sm shadow-lg hover:bg-indigo-700 transition-colors transform hover:scale-105">Log Masuk Klien</button>
            </nav>
          </header>
          <div class="flex flex-col sm:flex-row items-center justify-center p-8 bg-white rounded-3xl shadow-2xl mt-24">
            <div class="flex flex-col items-start text-left w-full sm:w-1/2 p-4">
                <div class="font-bold text-lg text-slate-500 mb-4">Aplikasi Web</div>
                <h1 class="font-extrabold text-3xl sm:text-5xl lg:text-6xl text-slate-800 leading-tight">
                    Semakan Jurang Halal <br class="hidden sm:block"> (eHalalGAP)
                </h1>
                <p class="mt-4 text-sm sm:text-lg text-slate-600 max-w-sm">
                    Ke Arah Automasi Proses Permohonan Halal
                </p>
                <button id="get-started-btn-body" class="mt-8 px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium shadow-md hover:bg-indigo-700 transition-colors duration-200">
                    Mulakan
                </button>
            </div>
            <div class="relative w-full sm:w-1/2 p-4 flex items-center justify-center min-h-[300px] sm:min-h-[500px]">
              <img id="landing-hero-image" class="w-full h-auto object-contain transition-opacity duration-500 opacity-0" />
            </div>
          </div>
        `;
        document.getElementById('page-landing').innerHTML = landingPageHtml;

        document.getElementById('get-started-btn-body').addEventListener('click', () => {
          renderPage('login');
        });
        document.getElementById('get-started-btn-header').addEventListener('click', () => {
          renderPage('login');
        });
        
        const imageUrlEl = document.getElementById('landing-hero-image');
        imageUrlEl.src = "https://raw.githubusercontent.com/goldigger79/HaCeRaapp/main/image%201.png";
        imageUrlEl.onload = () => { imageUrlEl.classList.remove('opacity-0'); };
        imageUrlEl.onerror = () => { imageUrlEl.src = "https://placehold.co/1200x800/e0f2fe/1e3a8a?text=Image+Failed+to+Load"; imageUrlEl.classList.remove('opacity-0'); };
    }

    function renderLoginPage() {
      const loginPageHtml = `
        <div class="flex flex-col items-center justify-center p-8 bg-white rounded-3xl shadow-2xl max-w-lg mx-auto mt-20">
          <div class="flex flex-col items-center justify-center gap-4 mb-6 text-center">
            <div class="font-extrabold text-5xl">eHalalGAP</div>
            <div class="text-sm text-slate-500">Semakan Jurang Halal (eHalalGAP)</div>
          </div>
          <h2 class="text-4xl font-extrabold text-center text-slate-800">Log Masuk Klien</h2>
          <p class="mt-2 text-center text-slate-600">Sila log masuk atau daftar untuk memulakan.</p>
          <div class="mt-8 w-full space-y-4">
            <div id="client-auth-form" class="space-y-4 p-4 border rounded-xl bg-slate-50">
              <label class="block">
                <span class="text-sm font-medium text-slate-700">E-mel</span>
                <input type="email" id="client-email-input" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" />
              </label>
              <label class="block">
                <span class="text-sm font-medium text-slate-700">Kata Laluan</span>
                <input type="password" id="client-password-input" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-ring-opacity-50" />
              </label>
              <button id="client-login-btn" class="w-full py-3 px-6 bg-indigo-600 text-white rounded-lg font-semibold shadow-lg hover:bg-indigo-700 transition-colors transform hover:scale-105">
                Log Masuk
              </button>
              <button id="client-signup-btn" class="w-full py-3 px-6 border border-slate-300 text-slate-800 rounded-lg font-semibold hover:bg-slate-100 transition-colors transform hover:scale-105">
                Daftar
              </button>
              <button id="forgot-password-btn" class="w-full text-sm text-indigo-500 hover:text-indigo-700 transition-colors duration-200 mt-2">
                Lupa kata laluan?
              </button>
            </div>
            <a href="/index.html" class="block text-center w-full py-4 px-6 border border-slate-300 text-slate-800 rounded-full font-semibold hover:bg-slate-100 transition-colors transform hover:scale-105">
              Utama
            </a>
          </div>
        </div>
      `;
      document.getElementById('page-login').innerHTML = loginPageHtml;
      document.getElementById('client-login-btn').addEventListener('click', () => handleClientLogin('login'));
      document.getElementById('client-signup-btn').addEventListener('click', () => handleClientLogin('signup'));
      document.getElementById('forgot-password-btn').addEventListener('click', () => handlePasswordReset());
    }
    
    function getProgress() {
        if (!checklist) return { total: 0, done: 0, percent: 0 };
        const total = checklist.length;
        const done = checklist.filter(i => i.done).length;
        return { total, done, percent: Math.round((done / total) * 100) };
    }

    function renderHomePage() {
      const progress = getProgress();
      const text = "Proses pensijilan Halal boleh menjadi rumit. e-HalalGAP memudahkannya dengan membantu anda menjejaki kesiapsiagaan, menggambarkan kemajuan, dan mengurus semua dokumentasi anda di satu tempat.";
      
      const missingRequired = checklist.filter(item => item.required && !item.done);
      const nextSteps = missingRequired.slice(0, 3);
      
      const nextStepsHtml = nextSteps.length > 0 ? `
        <h4 class="font-semibold text-lg text-slate-700 mt-8">Langkah Seterusnya & Keutamaan</h4>
        <ul class="mt-2 text-sm text-slate-600 space-y-2">
          ${nextSteps.map(item => `
            <li class="p-3 bg-slate-50 border border-slate-200 rounded-lg flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-indigo-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M15 12a2 2 0 11-4 0 2 2 0 014 0z" />
              </svg>
              ${item.title}
            </li>
          `).join('')}
        </ul>
      ` : `
        <div class="mt-8 text-center text-slate-500">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-green-500" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
          <p class="mt-2 text-lg font-semibold text-green-700">Semua item wajib telah lengkap!</p>
          <p class="text-sm">Anda bersedia untuk langkah seterusnya dalam proses permohonan.</p>
        </div>
      `;
      
      const documentsSubmitted = checklist.filter(item => item.fileUrl).length;
      const requiredItemsRemaining = checklist.filter(item => item.required && !item.done).length;
      const consultantComments = checklist.filter(item => item.comment).length;

      const kpiHtml = `
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
            <div class="bg-indigo-50 p-4 rounded-xl text-center shadow-md">
              <div class="text-xl font-bold text-indigo-600">${documentsSubmitted}</div>
              <div class="text-sm text-indigo-800">Dokumen Dimuat Naik</div>
            </div>
            <div class="bg-rose-50 p-4 rounded-xl text-center shadow-md">
              <div class="text-xl font-bold text-rose-600">${requiredItemsRemaining}</div>
              <div class="text-sm text-rose-800">Wajib Belum Selesai</div>
            </div>
            <div class="bg-cyan-50 p-4 rounded-xl text-center shadow-md">
              <div class="text-xl font-bold text-cyan-600">${consultantComments}</div>
              <div class="text-sm text-cyan-800">Komen Perunding</div>
            </div>
          </div>
      `;

      const homePageHtml = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div class="md:col-span-2 bg-white p-6 sm:p-8 rounded-3xl shadow-xl">
            <h2 class="text-2xl font-semibold text-slate-800">Mengapa e-HalalGAP?</h2>
            <p class="mt-4 text-slate-600">${text}</p>
            <div id="dynamic-dashboard-info" class="mt-6">
              ${kpiHtml}
            </div>
            <div class="mt-8 flex gap-4 flex-wrap">
              <button id="start-btn" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-cyan-400 text-white rounded-lg font-medium shadow-lg hover:from-indigo-700 hover:to-cyan-500 transition-colors duration-200">Mulakan Senarai Semak</button>
              <a class="px-6 py-3 border border-slate-300 text-slate-700 rounded-lg font-medium hover:bg-slate-100 transition-colors duration-200" href="#sample-links">Contoh Dokumen</a>
            </div>
            <section class="mt-8" id="sample-links">
              <h3 class="font-semibold text-lg">Contoh Dokumen</h3>
              <ul class="mt-3 text-sm text-slate-600 list-disc list-inside space-y-1">
                <li><a class="underline text-indigo-500 hover:text-indigo-600" href="https://example.com/sample-docs/registration.pdf" target="_blank" rel="noreferrer">Sijil Pendaftaran Syarikat & Lesen Perniagaan (contoh)</a></li>
                <li><a class="underline text-indigo-500 hover:text-indigo-600" href="https://example.com/sample-docs/ingredients.pdf" target="_blank" rel="noreferrer">Spesifikasi Bahan (contoh)</a></li>
                <li><a class="underline text-indigo-500 hover:text-indigo-600" href="https://example.com/sample-docs/sop.pdf" target="_blank" rel="noreferrer">SOP Pengendalian Halal (contoh)</a></li>
              </ul>
            </section>
          </div>
          <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-xl flex flex-col justify-between">
            <div>
              <h3 class="font-semibold text-lg">Kesiapsiagaan Semasa</h3>
              <div class="mt-4">
                <div class="text-sm text-slate-500">Selesai</div>
                <div class="mt-1 text-4xl font-bold text-center">${progress.done}/${progress.total}</div>
                <div class="w-full max-w-[176px] h-44 mt-6 mx-auto">
                    <svg viewBox="0 0 100 100" class="w-full h-full">
                      <circle cx="50" cy="50" r="40" fill="none" stroke="#E5E7EB" stroke-width="20" />
                      <path d="M 50 10 A 40 40 0 ${progress.percent > 50 ? 1 : 0} 1 ${50 + 40 * Math.sin(2 * Math.PI * progress.percent / 100)} ${50 - 40 * Math.cos(2 * Math.PI * progress.percent / 100)}" fill="none" stroke="#10B981" stroke-width="20" stroke-linecap="round" />
                    </svg>
                </div>
              </div>
              ${nextStepsHtml}
            </div>
            <div class="mt-8">
              <h4 class="font-semibold text-lg text-slate-700">Petua Pantas</h4>
              <ul class="mt-2 text-xs text-slate-600 list-disc list-inside space-y-1">
                <li>Kumpul pengisytiharan pembekal lebih awal.</li>
                <li>Simpan salinan imbasan SOP dan rekod latihan.</li>
                <li>Gunakan HaCeRa untuk menjejaki kemajuan dan menjana laporan untuk perunding anda.</li>
              </ul>
            </div>
          </aside>
        </div>
      `;
      document.getElementById('page-home').innerHTML = homePageHtml;
      document.getElementById('start-btn').addEventListener('click', () => {
        renderPage('checklist');
      });
    }

    function renderChecklistPage() {
      const progress = getProgress();
      const byCategory = checklist.reduce((acc, it) => {
        acc[it.category] = acc[it.category] || [];
        acc[it.category].push(it);
        return acc;
      }, {});
    
      const checklistHtml = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2 bg-white p-6 sm:p-8 rounded-3xl shadow-xl">
            <h2 class="text-2xl font-semibold">Senarai Semak Sijil Halal</h2>
            <p class="mt-2 text-slate-500">Tandakan item yang telah anda sediakan atau muat naik dokumen yang diperlukan. Gunakan pautan contoh sebagai rujukan.</p>
            <div class="mt-6 space-y-6" id="checklist-items-container">
              ${Object.keys(byCategory).map(cat => `
                <div class="p-5 border border-slate-200 rounded-2xl bg-slate-50/50 shadow-inner">
                  <h3 class="font-semibold text-lg text-indigo-700">${cat}</h3>
                  <div class="mt-3 grid gap-4">
                    ${byCategory[cat].map(item => `
                      <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between bg-white p-4 rounded-xl shadow-md transition-all duration-200 hover:shadow-lg">
                        <div class="flex items-start gap-4 flex-grow">
                          <input type="checkbox" id="cb-${item.id}" ${item.done ? 'checked' : ''} class="mt-1 h-5 w-5 rounded-md text-indigo-600 focus:ring-indigo-500 border-slate-300 toggle-checkbox" data-id="${item.id}" />
                          <div class="flex-1">
                            <label for="cb-${item.id}" class="font-medium text-slate-800 cursor-pointer">${item.title}</label>
                            <div class="text-sm text-slate-500 mt-1">
                              ${item.required ? 'Wajib' : 'Pilihan'}
                              <span class="mx-1">•</span>
                              <a class="underline text-indigo-500 hover:text-indigo-600" href="${item.sampleLink}" target="_blank" rel="noreferrer">Contoh</a>
                              <button class="clarify-btn text-indigo-500 hover:text-indigo-600 ml-2" data-item-title="${item.title}">
                                ✨ Dapatkan Penjelasan
                              </button>
                            </div>
                            ${item.comment ? `
                              <div class="mt-3 p-3 rounded-lg bg-indigo-50 text-sm text-slate-700 border border-indigo-100">
                                <span class="font-semibold text-indigo-800">Komen Perunding:</span> ${item.comment}
                              </div>
                            ` : ''}
                          </div>
                        </div>
                        <div class="mt-4 sm:mt-0 flex-shrink-0">
                        ${item.done ? `
                          ${item.fileUrl ? `
                            <a href="${item.fileUrl}" target="_blank" rel="noopener noreferrer" class="text-sm text-indigo-600 flex items-center gap-1 font-medium hover:underline">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                              </svg>
                              Lihat Dokumen
                            </a>
                          ` : `
                            <div class="text-sm text-green-600 flex items-center gap-1 font-medium">
                              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                              </svg>
                              Selesai
                            </div>
                          `}
                        ` : `
                          <label for="upload-input-${item.id}" class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-indigo-600 text-white rounded-lg text-sm font-medium shadow-md hover:from-indigo-600 hover:to-indigo-700 transition-colors duration-200 transform hover:scale-105 cursor-pointer">
                            Muat Naik Fail
                          </label>
                          <input type="file" id="upload-input-${item.id}" class="hidden upload-input" accept="application/pdf,image/jpeg" data-id="${item.id}" />
                        `}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              `).join('')}
            </div>
            <div class="mt-8 flex gap-4">
              <button id="export-pdf-btn" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-cyan-400 text-white rounded-lg font-medium shadow-lg hover:from-indigo-700 hover:to-cyan-500 transition-colors duration-200">Eksport sebagai PDF</button>
            </div>
          </div>
          <aside class="bg-white p-6 sm:p-8 rounded-3xl shadow-xl">
            <h3 class="font-semibold text-lg">Ringkasan Kesiapsiagaan</h3>
            <div class="mt-6 w-full flex-1">
              <div class="text-sm text-slate-500">Kemajuan</div>
              <div class="mt-1 text-4xl font-bold text-center">${progress.percent}%</div>
              <div class="w-full max-w-[176px] h-44 mt-6 mx-auto">
                <svg viewBox="0 0 100 100" class="w-full h-full">
                  <circle cx="50" cy="50" r="40" fill="none" stroke="#E5E7EB" stroke-width="20" />
                  <path d="M 50 10 A 40 40 0 ${progress.percent > 50 ? 1 : 0} 1 ${50 + 40 * Math.sin(2 * Math.PI * progress.percent / 100)} ${50 - 40 * Math.cos(2 * Math.PI * progress.percent / 100)}" fill="none" stroke="#10B981" stroke-width="20" stroke-linecap="round" />
                </svg>
              </div>
            </div>
            <div class="mt-8 w-full">
              <h4 class="font-semibold text-lg text-slate-700">Petua Pantas</h4>
              <ul class="mt-2 text-xs text-slate-600 list-disc list-inside space-y-1">
                <li>Kumpul pengisytiharan pembekal lebih awal.</li>
                <li>Simpan salinan imbasan SOP dan rekod latihan.</li>
                <li>Gunakan HaCeRa untuk menjejaki kemajuan dan menjana laporan untuk perunding anda.</li>
              </ul>
            </div>
          </aside>
        </div>
      `;
      document.getElementById('page-checklist').innerHTML = checklistHtml;
      document.querySelectorAll('.toggle-checkbox').forEach(cb => {
        cb.addEventListener('change', () => toggleDone(parseInt(cb.dataset.id)));
      });
      document.querySelectorAll('.upload-input').forEach(input => {
        input.addEventListener('change', (e) => handleUpload(parseInt(e.target.dataset.id), e.target.files));
      });
      document.querySelectorAll('.clarify-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          generateClarification(e.target.dataset.itemTitle);
        });
      });
    }

    function renderMyProfilePage() {
      const profile = clientData?.profile || {};
      const profileHtml = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-xl">
            <h2 class="text-2xl font-semibold">Profil Syarikat Saya</h2>
            <p class="mt-2 text-slate-500">Isikan butiran syarikat anda untuk membantu perunding anda.</p>
            <div class="mt-6 space-y-4">
              <label class="block">
                <span class="text-sm font-medium text-slate-700">Nama Syarikat</span>
                <input type="text" id="companyName" value="${profile.companyName || ''}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-colors duration-200" />
              </label>
              <label class="block">
                <span class="text-sm font-medium text-slate-700">Jenis Syarikat</span>
                <input type="text" id="companyType" value="${profile.companyType || ''}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-ring-indigo-200 focus:ring-opacity-50 transition-colors duration-200" />
              </label>
              <label class="block">
                <span class="text-sm font-medium text-slate-700">Orang Hubungan</span>
                <input type="text" id="contactName" value="${profile.contactName || ''}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-colors duration-200" />
              </label>
              <label class="block">
                <span class="text-sm font-medium text-slate-700">E-mel Hubungan</span>
                <input type="email" id="contactEmail" value="${profile.contactEmail || ''}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-colors duration-200" />
              </label>
              <label class="block">
                <span class="text-sm font-medium text-slate-700">Telefon Hubungan</span>
                <input type="tel" id="contactPhone" value="${profile.contactPhone || ''}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-colors duration-200" />
              </label>
            </div>
            <div class="mt-8">
              <button id="save-profile-btn" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-cyan-400 text-white rounded-lg font-medium shadow-lg hover:from-indigo-700 hover:to-cyan-500 transition-colors duration-200 transform hover:scale-105">Simpan Profil</button>
            </div>
          </div>
          <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-xl">
            <h3 class="text-2xl font-semibold">Pratonton Profil</h3>
            <div class="mt-4 p-6 border border-slate-200 rounded-xl shadow-inner">
              <div id="preview-companyName" class="text-xl font-medium">${profile.companyName || 'Nama Syarikat Anda'}</div>
              <div id="preview-companyType" class="text-sm text-slate-500">${profile.companyType || 'Jenis Syarikat'}</div>
              <div class="mt-6 text-sm text-slate-500 font-medium">Orang Hubungan</div>
              <div id="preview-contactName" class="text-lg font-medium text-slate-800">${profile.contactName || 'T/A'}</div>
              <div id="preview-contactEmail" class="text-sm text-indigo-600 font-medium">${profile.contactEmail || 'T/A'}</div>
              <div id="preview-contactPhone" class="text-sm text-slate-600 font-medium">${profile.contactPhone || 'T/A'}</div>
            </div>
          </div>
        </div>
      `;
      document.getElementById('page-profile').innerHTML = profileHtml;
      
      const inputs = ['companyName', 'companyType', 'contactName', 'contactEmail', 'contactPhone'];
      inputs.forEach(id => {
          document.getElementById(id).addEventListener('input', (e) => {
              const previewEl = document.getElementById(`preview-${id}`);
              if(previewEl) previewEl.innerText = e.target.value || 'T/A';
          });
      });

      document.getElementById('save-profile-btn').addEventListener('click', () => {
        const newProfile = {
          companyName: document.getElementById('companyName').value,
          companyType: document.getElementById('companyType').value,
          contactName: document.getElementById('contactName').value,
          contactEmail: document.getElementById('contactEmail').value,
          contactPhone: document.getElementById('contactPhone').value
        };
        saveProfile(newProfile);
      });
    }
    
    function renderConsultantPage() {
      const consultantHtml = `
        <div class="bg-white p-6 sm:p-8 rounded-3xl shadow-xl">
          <div class="flex justify-between items-center mb-6 flex-wrap gap-2">
            <h2 class="text-2xl font-semibold">Papan Pemuka Perunding</h2>
            <div class="text-sm text-slate-500">Urus klien & penilaian</div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left table-auto border-collapse">
              <thead>
                <tr class="text-xs font-semibold text-slate-500 uppercase border-b border-slate-200">
                  <th class="p-4">Klien</th>
                  <th class="p-4">Jenis</th>
                  <th class="p-4">Status</th>
                  <th class="p-4">Kemajuan</th>
                  <th class="p-4">Kemas kini terakhir</th>
                  <th class="p-4">Tindakan</th>
                </tr>
              </thead>
              <tbody id="clients-table-body">
                <tr><td colspan="6" class="p-4 text-center text-slate-500">Memuatkan klien...</td></tr>
              </tbody>
            </table>
          </div>
          <div class="mt-6 text-xs text-slate-500">Petua: Klik klien untuk membuka profil mereka, menyemak penilaian, dan menjana laporan kesiapsiagaan.</div>
        </div>
      `;
      document.getElementById('page-consultant-dashboard').innerHTML = consultantHtml;
      
      const publicClientsCollectionRef = collection(db, PUBLIC_DATA_PATH);
      if (unsubscribeConsultantListener) unsubscribeConsultantListener();
      unsubscribeConsultantListener = onSnapshot(publicClientsCollectionRef, (querySnapshot) => {
        clients = [];
        querySnapshot.forEach(docSnap => {
            const clientData = docSnap.data();
            clients.push({
              id: docSnap.id,
              name: clientData.profile?.companyName || `Klien ${docSnap.id.substring(0, 5)}`,
              type: clientData.profile?.companyType || 'T/A',
              status: clientData.progress === 100 ? 'Sedia' : 'Dalam Proses',
              progress: clientData.progress || 0,
              updated: clientData.updated || 'T/A',
              assessment: clientData.assessment || []
            });
        });
        updateConsultantTable();
      }, (error) => {
        console.error("Error fetching client profiles:", error);
        document.getElementById('clients-table-body').innerHTML = `<tr><td colspan="6" class="p-4 text-center text-rose-500">Gagal memuatkan klien. Kebenaran mungkin tidak mencukupi.</td></tr>`;
      });
    }

    function updateConsultantTable() {
      const tableBody = document.getElementById('clients-table-body');
      if (!tableBody) return;
      
      const tableRows = clients.map(c => `
        <tr class="border-t border-slate-200 transition-all duration-200 hover:bg-slate-50">
          <td class="p-4 font-medium text-slate-800">${c.name}</td>
          <td class="p-4 text-sm text-slate-600">${c.type}</td>
          <td class="p-4">${c.status}</td>
          <td class="p-4 w-64">
            <div class="text-sm">${c.progress}%</div>
            <div class="w-full bg-slate-200 h-2 rounded-full mt-1"><div style="width: ${c.progress}%" class="h-full bg-gradient-to-r from-indigo-500 to-cyan-400"></div></div>
          </td>
          <td class="p-4 text-sm text-slate-500">${c.updated}</td>
          <td class="p-4">
            <button class="open-client-btn px-4 py-2 rounded-lg border border-slate-300 text-slate-700 font-medium hover:bg-slate-100 transition-colors duration-200" data-id="${c.id}">Buka</button>
          </td>
        </tr>
      `).join('');
      tableBody.innerHTML = tableRows || `<tr><td colspan="6" class="p-4 text-center text-slate-500">Tiada klien ditemui. Sila minta klien log masuk untuk mencipta profil.</td></tr>`;

      document.querySelectorAll('.open-client-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedClientId = btn.dataset.id;
          updateUI();
        });
      });
    }

    function renderClientProfilePage() {
      const client = clients.find(c => c.id === selectedClientId);
      if (!client) {
          renderPage('consultant');
          return;
      }

      const assessmentHtml = client.assessment.map(it => `
        <div class="p-5 border border-slate-200 rounded-2xl bg-slate-50/50 shadow-inner">
          <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between">
            <div class="flex items-start gap-4 flex-grow">
              <input type="checkbox" id="consultant-cb-${it.id}" ${it.done ? 'checked' : ''} class="mt-1 h-5 w-5 rounded-md text-indigo-600 focus:ring-indigo-500 border-slate-300 consultant-toggle-checkbox" data-id="${it.id}" />
              <div class="flex-1">
                <label for="consultant-cb-${it.id}" class="font-medium text-slate-800">${it.title}</label>
                <div class="text-sm text-slate-500 mt-1">
                  ${it.category}
                  <span class="mx-1">•</span>
                  ${it.fileUrl ? `
                    <a href="${it.fileUrl}" target="_blank" rel="noopener noreferrer" class="underline text-indigo-500 hover:text-indigo-600">Lihat Fail</a>
                  ` : `
                    <a class="underline text-indigo-500 hover:text-indigo-600" href="${it.sampleLink}" target="_blank" rel="noreferrer">Contoh</a>
                  `}
                </div>
              </div>
            </div>
            <div class="mt-2 sm:mt-0 text-xs text-slate-400 font-medium flex-shrink-0">${it.required ? 'Wajib' : 'Pilihan'}</div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-slate-700">
              Komen Perunding:
              <textarea
                id="comment-ta-${it.id}"
                data-id="${it.id}"
                rows="2"
                class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-colors duration-200 consultant-comment"
                placeholder="Tambah komen untuk klien..."
              >${it.comment || ''}</textarea>
            </label>
          </div>
        </div>
      `).join('');

      const clientProfileHtml = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2 bg-white p-6 sm:p-8 rounded-3xl shadow-xl">
            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between">
              <div>
                <h2 class="text-2xl font-semibold">${client.name}</h2>
                <div class="text-sm text-slate-500">${client.type} • ${client.status}</div>
              </div>
              <div class="text-right mt-4 sm:mt-0">
                <div class="text-sm text-slate-500">Kemajuan</div>
                <div class="text-4xl font-bold">${client.progress}%</div>
              </div>
            </div>
            <div class="mt-6">
              <h3 class="font-semibold text-lg">Item Penilaian</h3>
              <div class="mt-4 space-y-4">
                ${assessmentHtml}
              </div>
            </div>
            <div class="mt-8 flex gap-4 flex-wrap">
              <button id="save-consultant-changes-btn" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-cyan-400 text-white rounded-lg font-medium shadow-lg hover:from-indigo-700 hover:to-cyan-500 transition-colors duration-200">Simpan Perubahan</button>
              <button id="generate-report-btn" class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-cyan-400 text-white rounded-lg font-medium shadow-lg hover:from-indigo-700 hover:to-cyan-500 transition-colors duration-200">✨ Jana Laporan</button>
              <button id="message-client-btn" class="px-6 py-3 border border-slate-300 rounded-lg font-medium hover:bg-slate-100 transition-colors duration-200">Mesej Klien</button>
            </div>
          </div>
          <aside class="bg-white p-6 sm:p-8 rounded-3xl shadow-xl">
            <h3 class="font-semibold text-lg">Ringkasan</h3>
            <div id="summary-report-content" class="mt-4 text-sm text-slate-600">${client.notes || 'Klik "Jana Laporan" untuk mendapatkan ringkasan kesiapsiagaan berkuasa AI.'}</div>
          </aside>
        </div>
      `;
      document.getElementById('page-consultant-client').innerHTML = clientProfileHtml;

      document.querySelectorAll('.consultant-toggle-checkbox').forEach(cb => {
        cb.addEventListener('change', async () => {
          const currentClient = clients.find(c => c.id === selectedClientId);
          if (!currentClient) return;

          const updatedAssessment = currentClient.assessment.map(item => {
            const checkbox = document.getElementById(`consultant-cb-${item.id}`);
            return item.id === parseInt(checkbox.dataset.id) ? { ...item, done: checkbox.checked } : item;
          });

          const updatedProgress = Math.round((updatedAssessment.filter(x => x.done).length / updatedAssessment.length) * 100);
          await saveConsultantAssessment(selectedClientId, {
            assessment: updatedAssessment,
            progress: updatedProgress,
            updated: new Date().toLocaleString()
          });
        });
      });

      document.querySelectorAll('.consultant-comment').forEach(ta => {
        ta.addEventListener('input', async (e) => {
          const currentClient = clients.find(c => c.id === selectedClientId);
          if (!currentClient) return;

          const updatedAssessment = currentClient.assessment.map(item => {
            return item.id === parseInt(e.target.dataset.id) ? { ...item, comment: e.target.value } : item;
          });

          await saveConsultantAssessment(selectedClientId, {
            assessment: updatedAssessment,
            updated: new Date().toLocaleString()
          });
        });
      });
      
      document.getElementById('save-consultant-changes-btn').addEventListener('click', async () => {
        const currentClient = clients.find(c => c.id === selectedClientId);
        if (!currentClient) return;

        const updatedAssessment = currentClient.assessment.map(item => {
            const checkbox = document.getElementById(`consultant-cb-${item.id}`);
            const textarea = document.getElementById(`comment-ta-${item.id}`);
            return {
                ...item,
                done: checkbox.checked,
                comment: textarea.value
            };
        });

        const updatedProgress = Math.round((updatedAssessment.filter(x => x.done).length / updatedAssessment.length) * 100);
        await saveConsultantAssessment(selectedClientId, {
            assessment: updatedAssessment,
            progress: updatedProgress,
            updated: new Date().toLocaleString()
        });
        showModal('Perubahan Disimpan', 'Penilaian klien telah berjaya dikemas kini.');
      });


      document.getElementById('generate-report-btn').addEventListener('click', () => {
        generateReport(client.name, client.assessment);
      });
      document.getElementById('message-client-btn').addEventListener('click', () => {
        showModal('Mesej Dihantar', 'Pemberitahuan telah dihantar kepada klien melalui e-mel.');
      });
    }
    
    async function handleAdminLogin() {
      const email = document.getElementById('consultant-email-input').value;
      const password = document.getElementById('consultant-password-input').value;
      if (!email || !password) {
          showModal('Log Masuk Gagal', 'Sila masukkan e-mel dan kata laluan.');
          return;
      }

      try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        const userDocRef = doc(db, USERS_COLLECTION, user.uid);
        const userDocSnap = await getDoc(userDocRef);
        
        if (userDocSnap.exists() && userDocSnap.data().role === 'consultant') {
          // Success, onAuthStateChanged will handle the rest
        } else {
          // Not a consultant, log out for security
          await signOut(auth);
          showModal('Akses Ditolak', 'Akaun ini tidak dibenarkan sebagai perunding.');
        }
      } catch (error) {
        let message = 'Berlaku ralat yang tidak dijangka.';
        if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') {
            message = 'E-mel atau kata laluan tidak sah. Sila cuba lagi.';
        } else {
            message = `Log masuk gagal: ${error.message}`;
        }
        console.error("Consultant login failed:", error);
        showModal('Log Masuk Gagal', message);
      }
    }


    async function saveConsultantAssessment(clientId, updates) {
      try {
        const publicDocRef = doc(db, PUBLIC_DATA_PATH, clientId);
        await setDoc(publicDocRef, updates, { merge: true });
        // The UI will be updated by the snapshot listener, so no modal needed here
      } catch (e) {
        console.error("Error saving consultant changes:", e);
        showModal('Simpan Gagal', `Berlaku ralat semasa menyimpan perubahan: ${e.message}`);
      }
    }

    async function generateClarification(itemTitle) {
      showModal('Memuatkan Penjelasan', 'Sistem sedang menjana penjelasan untuk item ini...');
      
      const systemPrompt = "Bertindak sebagai pakar pensijilan Halal JAKIM yang berpengetahuan. Berikan penjelasan yang ringkas (maksimum 3 perenggan) mengenai keperluan item senarai semak yang diberikan, menggunakan bahasa Melayu yang formal dan jelas.";
      const userQuery = `Terangkan keperluan untuk senarai semak Halal: "${itemTitle}"`;
      const apiKey = "" 
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

      try {
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Gagal menjana penjelasan. Sila cuba sebentar lagi.";
        
        showModal(`Penjelasan: ${itemTitle}`, text);

      } catch (e) {
        console.error("Gemini API call failed:", e);
        showModal('Gagal Menjana Penjelasan', 'Sambungan ke perkhidmatan AI gagal. Sila cuba lagi.');
      }
    }

    async function generateReport(clientName, assessment) {
      document.getElementById('summary-report-content').innerHTML = `<div class="text-center py-4"><svg class="animate-spin h-5 w-5 text-indigo-500 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><p class="text-sm text-indigo-600 mt-2">Menganalisis kemajuan...</p></div>`;

      const systemPrompt = "Bertindak sebagai perunding pensijilan Halal yang cemerlang. Analisis data penilaian klien yang diberikan. Berikan ringkasan profesional, padat, dalam 3-4 perenggan sahaja, merangkumi: (1) Status kesiapsiagaan keseluruhan dan skor. (2) 2-3 kelemahan/dokumen utama yang hilang yang menghalang kelulusan segera. (3) 2-3 kekuatan utama/item yang telah dilengkapkan. (4) Cadangan langkah segera yang perlu diambil oleh klien. Tulis laporan ini sepenuhnya dalam Bahasa Melayu.";
      
      const assessmentSummary = assessment.map(item => `[${item.done ? 'LENGKAP' : 'BELUM'}] ${item.title} (${item.category}). Komen Perunding: ${item.comment || 'Tiada'}`).join('\n');
      
      const userQuery = `Jana Laporan Kesiapsiagaan Halal untuk Klien: ${clientName}. Berikut adalah data penilaian mereka:\n\n${assessmentSummary}`;
      
      const apiKey = "" 
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

      try {
        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        let reportText = result.candidates?.[0]?.content?.parts?.[0]?.text || "Gagal menjana laporan. Sila cuba sebentar lagi.";
        
        // Convert Markdown formatting (like ** and *) to HTML for display
        reportText = reportText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        reportText = reportText.replace(/\n\n/g, '</p><p class="mt-3">');
        reportText = `<p>${reportText}</p>`;
        
        document.getElementById('summary-report-content').innerHTML = reportText;

      } catch (e) {
        console.error("Gemini API call failed:", e);
        document.getElementById('summary-report-content').innerHTML = '<p class="text-rose-500">Gagal menyambung ke perkhidmatan AI. Sila semak sambungan internet anda atau cuba lagi.</p>';
      }
    }


    // Data persistence functions
    async function saveAssessment() {
      if (!userId || isConsultant) return;
      try {
        const privateDocRef = doc(db, PRIVATE_DATA_PATH(userId), 'profile');
        const publicDocRef = doc(db, PUBLIC_DATA_PATH, userId);
        const progress = Math.round((checklist.filter(x => x.done).length / checklist.length) * 100);
        
        await setDoc(privateDocRef, {
          assessment: checklist,
          progress,
          updated: new Date().toLocaleString()
        }, { merge: true });

        // Update the public data for the consultant
        await setDoc(publicDocRef, {
          assessment: checklist,
          progress,
          updated: new Date().toLocaleString()
        }, { merge: true });

      } catch (e) {
        console.error("Error saving assessment:", e);
      }
    }

    async function saveProfile(newProfile) {
      if (!userId || isConsultant) return;
      try {
        const privateDocRef = doc(db, PRIVATE_DATA_PATH(userId), 'profile');
        const publicDocRef = doc(db, PUBLIC_DATA_PATH, userId);
        
        await setDoc(privateDocRef, {
          profile: newProfile,
          updated: new Date().toLocaleString()
        }, { merge: true });

        // Update the public data for the consultant
        await setDoc(publicDocRef, {
          profile: newProfile,
          updated: new Date().toLocaleString()
        }, { merge: true });
        
        showModal('Profil Disimpan', 'Profil syarikat anda telah berjaya disimpan.');
      } catch (e) {
        console.error("Error saving profile:", e);
        showModal('Gagal Menyimpan Profil', `Berlaku ralat: ${e.message}`);
      }
    }

    async function toggleDone(id) {
      checklist = checklist.map(it => it.id === id ? { ...it, done: !it.done } : it);
      await saveAssessment();
    }

    async function handleUpload(id, files) {
      if (files.length === 0) return;
      const file = files[0];
      const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 MB

      if (file.size > MAX_FILE_SIZE) {
        showModal('Muat Naik Gagal', 'Saiz fail melebihi had 5 MB. Sila muat naik fail yang lebih kecil.');
        return;
      }
      if (!['application/pdf', 'image/jpeg'].includes(file.type)) {
        showModal('Muat Naik Gagal', 'Jenis fail tidak sah. Hanya PDF dan JPEG dibenarkan.');
        return;
      }

      showModal('Memuat Naik...', 'Sila tunggu sementara fail anda dimuat naik.', true);

      try {
        const fileExtension = file.name.split('.').pop();
        const storageRef = ref(storage, `client_uploads/${userId}/${id}_${Date.now()}.${fileExtension}`);
        
        const uploadTask = uploadBytesResumable(storageRef, file);

        uploadTask.on('state_changed', 
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            document.getElementById('upload-progress-bar').style.width = `${progress}%`;
            document.getElementById('upload-progress-text').innerText = `${Math.round(progress)}%`;
          }, 
          (error) => {
            console.error("Upload failed:", error);
            hideModal();
            showModal('Muat Naik Gagal', `Ralat muat naik: ${error.message}`);
          }, 
          async () => {
            const fileUrl = await getDownloadURL(uploadTask.snapshot.ref);
            
            checklist = checklist.map(it => it.id === id ? { ...it, done: true, fileUrl: fileUrl } : it);
            await saveAssessment();

            hideModal();
            showModal('Muat Naik Berjaya', 'Fail anda telah berjaya dimuat naik dan item ditandakan sebagai selesai.');
            // Clear file input value to allow re-upload
            document.getElementById(`upload-input-${id}`).value = '';
          }
        );

      } catch (e) {
        console.error("Error during upload setup:", e);
        hideModal();
        showModal('Muat Naik Gagal', `Berlaku ralat muat naik: ${e.message}`);
      }
    }


    // Initial page render
    window.onload = () => {
        // No need to load appContent from Firestore anymore
        updateUI();
    };
  </script>
</body>
</html>
