<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HaCeRa: Halal Certificate Readiness App</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>
<body class="min-h-screen bg-slate-100 antialiased text-slate-800 flex flex-col items-center p-6">

  <!-- Main Application Container -->
  <main id="app-container" class="max-w-7xl w-full mx-auto">
    <!-- Navigation (Visible after login) -->
    <div id="nav-bar" class="flex justify-between items-center mb-6 hidden">
      <div class="flex-grow"></div>
      <div class="flex items-center space-x-2">
        <button id="nav-home" class="nav-button px-4 py-2 rounded-lg font-medium transition-colors duration-200 text-slate-700 hover:bg-slate-200">Home</button>
        <div id="client-nav-buttons" class="hidden flex items-center space-x-2">
          <button id="nav-checklist" class="nav-button px-4 py-2 rounded-lg font-medium transition-colors duration-200 text-slate-700 hover:bg-slate-200">Checklist</button>
          <button id="nav-profile" class="nav-button px-4 py-2 rounded-lg font-medium transition-colors duration-200 text-slate-700 hover:bg-slate-200">My Profile</button>
        </div>
        <div id="consultant-nav-buttons" class="hidden flex items-center space-x-2">
          <button id="nav-consultant-dashboard" class="nav-button px-4 py-2 rounded-lg font-medium transition-colors duration-200 text-slate-700 hover:bg-slate-200">Dashboard</button>
          <button id="nav-consultant-client" class="nav-button px-4 py-2 rounded-lg font-medium transition-colors duration-200 text-slate-700 hover:bg-slate-200 hidden">Client Profile</button>
        </div>
        <button id="logout-button" class="px-4 py-2 rounded-lg bg-rose-600 text-white font-medium hover:bg-rose-700 transition-colors duration-200">
          Log Out
        </button>
      </div>
    </div>

    <!-- Page Containers -->
    <div id="page-login"></div>
    <div id="page-home" class="hidden"></div>
    <div id="page-checklist" class="hidden"></div>
    <div id="page-profile" class="hidden"></div>
    <div id="page-consultant-dashboard" class="hidden"></div>
    <div id="page-consultant-client" class="hidden"></div>
  </main>

  <footer class="mt-12 text-xs text-slate-500 text-center">
    Copyright by ACE UniKL MICET 2025
  </footer>

  <!-- Modal Structure -->
  <div id="modal" class="fixed inset-0 bg-slate-900 bg-opacity-50 flex items-center justify-center p-4 z-50 opacity-0 invisible transition-opacity duration-300">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-sm w-full transform scale-95 transition-transform duration-300">
      <div class="flex justify-between items-center">
        <h3 id="modal-title" class="text-2xl font-bold text-slate-800"></h3>
        <button id="modal-close-btn" class="text-slate-400 hover:text-slate-600 transition-colors duration-200">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <p id="modal-message" class="mt-4 text-slate-600"></p>
      <div class="mt-8 text-right">
        <button id="modal-ok-btn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium hover:bg-indigo-700 transition-colors duration-200">Close</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, onSnapshot, setDoc, getDoc, setLogLevel, collection, query, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // Global state variables
    let page = 'login';
    let checklist = [];
    let clientData = null;
    let userId = null;
    let isConsultant = false;
    let selectedClientId = null;
    let clients = [];

    // Global Firebase instances
    let app, auth, db;

    // Firebase configuration and initialization
    const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

    if (Object.keys(firebaseConfig).length > 0) {
      try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app);
        setLogLevel('debug');
      } catch (e) {
        console.error("Firebase initialization failed:", e);
      }
    } else {
        console.error("Firebase configuration is missing.");
    }
    
    const PUBLIC_DATA_PATH = `artifacts/${appId}/public/data/clients`;
    const PRIVATE_DATA_PATH = (uid) => `artifacts/${appId}/users/${uid}/clientData`;

    const SAMPLE_CHECKLIST = [
      { id: 1, category: 'Documentation', title: 'Company registration certificate (SSM)', required: true, done: false, sampleLink: 'https://example.com/sample-docs/ssm.pdf', comment: '' },
      { id: 2, category: 'Documentation', title: 'Business/manufacturing license', required: true, done: false, sampleLink: 'https://example.com/sample-docs/license.pdf', comment: '' },
      { id: 3, category: 'Documentation', title: 'List of all products/services', required: true, done: false, sampleLink: 'https://example.com/sample-docs/products.pdf', comment: '' },
      { id: 4, category: 'Documentation', title: 'Complete list of all ingredients', required: true, done: false, sampleLink: 'https://example.com/sample-docs/ingredients.pdf', comment: '' },
      { id: 5, category: 'Documentation', title: 'Halal certificates for all ingredients', required: true, done: false, sampleLink: 'https://example.com/sample-docs/halal-certs.pdf', comment: '' },
      { id: 6, category: 'Documentation', title: 'Ingredient specification sheets', required: false, done: false, sampleLink: 'https://example.com/sample-docs/specs.pdf', comment: '' },
      { id: 7, category: 'Documentation', title: 'Process flow chart for each product', required: true, done: false, sampleLink: 'https://example.com/sample-docs/flow-chart.pdf', comment: '' },
      { id: 8, category: 'Documentation', title: 'Factory layout plan and location map', required: true, done: false, sampleLink: 'https://example.com/sample-docs/layout.pdf', comment: '' },
      { id: 9, category: 'Documentation', title: 'Photos of the manufacturing site', required: true, done: false, sampleLink: 'https://example.com/sample-docs/photos.pdf', comment: '' },
      { id: 10, category: 'Documentation', title: 'Product packaging artwork and labels', required: true, done: false, sampleLink: 'https://example.com/sample-docs/labels.pdf', comment: '' },
      { id: 11, category: 'Documentation', title: 'Other quality assurance certifications (HACCP, ISO, etc.)', required: false, done: false, sampleLink: 'https://example.com/sample-docs/certs.pdf', comment: '' },
      { id: 12, category: 'Documentation', title: 'Proof of financial viability (annual turnover)', required: true, done: false, sampleLink: 'https://example.com/sample-docs/turnover.pdf', comment: '' },
      { id: 13, category: 'Operational', title: 'Separate Halal product processing', required: true, done: false, sampleLink: 'https://example.com/sample-docs/segregation-plan.pdf', comment: '' },
      { id: 14, category: 'Operational', title: 'Equipment sanitation procedures', required: true, done: false, sampleLink: 'https://example.com/sample-docs/sanitation-sop.pdf', comment: '' },
      { id: 15, category: 'Operational', title: 'Premise hygiene and sanitation (GMP/GHP)', required: true, done: false, sampleLink: 'https://example.com/sample-docs/hygiene-plan.pdf', comment: '' },
      { id: 16, category: 'Operational', title: 'Business has been operational for at least 3 months', required: true, done: false, sampleLink: 'https://example.com/sample-docs/3-months-operation.pdf', comment: '' },
      { id: 17, category: 'Personnel', title: 'At least two full-time Muslim workers', required: true, done: false, sampleLink: 'https://example.com/sample-docs/employee-records.pdf', comment: '' },
      { id: 18, category: 'Personnel', title: 'Certified Halal Executive (if applicable)', required: true, done: false, sampleLink: 'https://example.com/sample-docs/halal-exec-cert.pdf', comment: '' },
      { id: 19, category: 'Personnel', title: 'Halal Assurance System Manual', required: true, done: false, sampleLink: 'https://example.com/sample-docs/has-manual.pdf', comment: '' },
      { id: 20, category: 'Personnel', title: 'Staff training on Halal principles', required: true, done: false, sampleLink: 'https://example.com/sample-docs/training-records.pdf', comment: '' }
    ];

    function createSampleClients() {
      const createAssessment = (doneItems, comments = {}) => {
        return SAMPLE_CHECKLIST.map(item => ({
          ...item,
          done: doneItems.includes(item.id),
          comment: comments[item.id] || ''
        }));
      };
      const createProfile = (name, type, contactName, contactEmail, contactPhone) => ({
        companyName: name, type, contactName, contactEmail, contactPhone
      });
      return [
        { id: 'c1', name: 'SateKita Foods', type: 'Food Manufacturer', status: 'In progress', progress: 45, updated: '2025-09-10 10:24', contact: { name: 'Ali', phone: '+60 12-345 6789', email: 'ali@satekita.com' }, assessment: createAssessment([1, 3, 7, 10, 13, 17, 19, 20], { 1: 'Please provide a clearer copy of the registration.', 17: 'Confirm the two Muslim employees are full-time and Malaysian citizens.' }), profile: createProfile('SateKita Foods', 'Food Manufacturer', 'Ali', 'ali@satekita.com', '+60 12-345 6789') },
        { id: 'c2', name: 'BakerMan Bakery', type: 'Food Premise', status: 'Ready for review', progress: 85, updated: '2025-09-12 09:10', contact: { name: 'Siti', phone: '+60 11-222 3333', email: 'siti@bakerman.my' }, assessment: createAssessment([1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18], { 18: 'Please provide the Halal Executive certification number for verification.' }), profile: createProfile('BakerMan Bakery', 'Food Premise', 'Siti', 'siti@bakerman.my', '+60 11-222 3333') },
        { id: 'c3', name: 'SauceMaker SME', type: 'SME (Sauces)', status: 'Needs documents', progress: 25, updated: '2025-09-08 14:05', contact: { name: 'Rahman', phone: '+60 19-444 5555', email: 'rahman@saucemaker.my' }, assessment: createAssessment([1, 2, 4, 7, 12, 13], { 4: 'We need the full ingredient list, including processing aids.', 12: 'Financial documents are missing.' }), profile: createProfile('SauceMaker SME', 'SME (Sauces)', 'Rahman', 'rahman@saucemaker.my', '+60 19-444 5555') },
      ];
    }
    
    // Auth state listener
    if(auth) {
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                if (!isConsultant) {
                    const clientDocRef = doc(db, PRIVATE_DATA_PATH(userId), 'profile');
                    const docSnap = await getDoc(clientDocRef);
                    if (!docSnap.exists()) {
                        await setDoc(clientDocRef, {
                            profile: { companyName: '', companyType: '', contactName: '', contactEmail: '', contactPhone: '' },
                            assessment: SAMPLE_CHECKLIST,
                            progress: 0,
                            updated: new Date().toLocaleString()
                        });
                    }
                    // Setup real-time listener for client data
                    onSnapshot(clientDocRef, (snap) => {
                      if (snap.exists()) {
                        clientData = snap.data();
                        checklist = clientData.assessment;
                        renderPage(page);
                      }
                    });
                }
                renderPage(page);
            } else {
                userId = null;
                clientData = null;
                checklist = SAMPLE_CHECKLIST;
                renderPage('login');
            }
        });
    }

    // Helper function to show/hide pages
    function renderPage(pageName) {
      page = pageName;
      document.querySelectorAll('#app-container > div').forEach(el => el.classList.add('hidden'));
      document.getElementById('nav-bar').classList.add('hidden');
      document.getElementById('nav-consultant-client').classList.add('hidden');
      document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('bg-indigo-600', 'text-white', 'shadow-md'));

      if (page === 'login') {
        document.getElementById('page-login').classList.remove('hidden');
        renderLoginPage();
      } else {
        document.getElementById('nav-bar').classList.remove('hidden');
        document.getElementById(`nav-${page.replace('consultant', 'consultant-dashboard').replace('client', 'consultant-client')}`).classList.add('bg-indigo-600', 'text-white', 'shadow-md');
        
        if (isConsultant) {
          document.getElementById('client-nav-buttons').classList.add('hidden');
          document.getElementById('consultant-nav-buttons').classList.remove('hidden');
          if (selectedClientId) {
            document.getElementById('nav-consultant-client').classList.remove('hidden');
          }
        } else {
          document.getElementById('client-nav-buttons').classList.remove('hidden');
          document.getElementById('consultant-nav-buttons').classList.add('hidden');
        }

        switch (page) {
          case 'home':
            document.getElementById('page-home').classList.remove('hidden');
            renderHomePage();
            break;
          case 'checklist':
            document.getElementById('page-checklist').classList.remove('hidden');
            renderChecklistPage();
            break;
          case 'profile':
            document.getElementById('page-profile').classList.remove('hidden');
            renderMyProfilePage();
            break;
          case 'consultant':
            document.getElementById('page-consultant-dashboard').classList.remove('hidden');
            renderConsultantPage();
            break;
          case 'client':
            document.getElementById('page-consultant-client').classList.remove('hidden');
            renderClientProfilePage();
            break;
        }
      }
    }

    // Modal functions
    function showModal(title, message) {
      document.getElementById('modal-title').innerText = title;
      document.getElementById('modal-message').innerText = message;
      document.getElementById('modal').classList.remove('opacity-0', 'invisible');
      document.querySelector('#modal > div').classList.remove('scale-95');
    }
    function hideModal() {
      document.getElementById('modal').classList.add('opacity-0', 'invisible');
      document.querySelector('#modal > div').classList.add('scale-95');
    }
    document.getElementById('modal-close-btn').addEventListener('click', hideModal);
    document.getElementById('modal-ok-btn').addEventListener('click', hideModal);

    // Page rendering functions
    function renderLoginPage() {
      const loginPageHtml = `
        <div class="flex flex-col items-center justify-center p-8 bg-white rounded-3xl shadow-2xl max-w-lg mx-auto mt-20">
          <div class="flex flex-col items-center justify-center gap-4 mb-6 text-center">
            <div class="font-extrabold text-5xl">HaCeRa</div>
            <div class="text-sm text-slate-500">Halal Certificate Readiness Assessment</div>
          </div>
          <h2 class="text-4xl font-extrabold text-center text-slate-800">Welcome</h2>
          <p class="mt-2 text-center text-slate-600">Please select your role to continue to the Halal Certificate Readiness Assessment.</p>
          <div class="mt-8 w-full space-y-4">
            <button id="client-login-btn" class="w-full py-4 px-6 bg-indigo-600 text-white rounded-full font-semibold shadow-lg hover:bg-indigo-700 transition-colors transform hover:scale-105">
              Log in as Client
            </button>
            <button id="consultant-login-btn" class="w-full py-4 px-6 border border-slate-300 text-slate-800 rounded-full font-semibold hover:bg-slate-100 transition-colors transform hover:scale-105">
              Log in as Consultant
            </button>
          </div>
        </div>
      `;
      document.getElementById('page-login').innerHTML = loginPageHtml;
      document.getElementById('client-login-btn').addEventListener('click', () => {
        isConsultant = false;
        handleLogin();
      });
      document.getElementById('consultant-login-btn').addEventListener('click', () => {
        isConsultant = true;
        handleLogin();
      });
    }
    
    function getProgress() {
        if (!checklist) return { total: 0, done: 0, percent: 0 };
        const total = checklist.length;
        const done = checklist.filter(i => i.done).length;
        return { total, done, percent: Math.round((done / total) * 100) };
    }

    function renderHomePage() {
      const progress = getProgress();
      const text = isConsultant
        ? "Business owners often find the Halal certification process to be complex and heavy on documentation. HaCeRa is designed to automate readiness checks, provide clear progress visualization, and give a powerful dashboard to track progress efficiently."
        : "Navigating the Halal certification process can be complex. HaCeRa simplifies this by helping you track your readiness, visualize your progress, and manage all your documentation in one place. Your consultant can also view your progress, making collaboration easier than ever.";
      
      const homePageHtml = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div class="md:col-span-2 bg-white p-8 rounded-3xl shadow-xl">
            <h2 class="text-2xl font-semibold text-slate-800">Why HaCeRa?</h2>
            <p class="mt-4 text-slate-600">${text}</p>
            <div class="mt-8 flex gap-4">
              <button id="start-btn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium shadow-md hover:bg-indigo-700 transition-colors duration-200">Start Checklist</button>
              <a class="px-6 py-3 border border-slate-300 text-slate-700 rounded-lg font-medium hover:bg-slate-100 transition-colors duration-200" href="#sample-links">Sample documents</a>
            </div>
            <section class="mt-8" id="sample-links">
              <h3 class="font-semibold text-lg">Sample documents</h3>
              <ul class="mt-3 text-sm text-slate-600 list-disc list-inside space-y-1">
                <li><a class="underline text-indigo-500 hover:text-indigo-600" href="https://example.com/sample-docs/registration.pdf" target="_blank" rel="noreferrer">Company Registration & Business License (sample)</a></li>
                <li><a class="underline text-indigo-500 hover:text-indigo-600" href="https://example.com/sample-docs/ingredients.pdf" target="_blank" rel="noreferrer">Ingredient Specifications (sample)</a></li>
                <li><a class="underline text-indigo-500 hover:text-indigo-600" href="https://example.com/sample-docs/sop.pdf" target="_blank" rel="noreferrer">SOP for Halal Handling (sample)</a></li>
              </ul>
            </section>
          </div>
          <div class="bg-white p-8 rounded-3xl shadow-xl flex flex-col justify-between">
            <div>
              <h3 class="font-semibold text-lg">Current readiness</h3>
              <div class="mt-4">
                <div class="text-sm text-slate-500">Completed</div>
                <div class="mt-1 text-4xl font-bold">${progress.done}/${progress.total}</div>
                <div class="mt-6">
                  <div class="w-full bg-slate-200 rounded-full h-3 overflow-hidden">
                    <div style="width: ${progress.percent}%" class="h-full bg-gradient-to-r from-indigo-500 to-cyan-400 transition-all duration-500 ease-out"></div>
                  </div>
                </div>
              </div>
            </div>
            <div class="mt-8">
              <h4 class="font-semibold text-lg text-slate-700">Quick Tips</h4>
              <ul class="mt-2 text-xs text-slate-600 list-disc list-inside space-y-1">
                <li>Collect supplier declarations early.</li>
                <li>Keep scanned copies of SOPs and training records.</li>
                <li>Use HaCeRa to track progress and generate reports for your consultant.</li>
              </ul>
            </div>
          </div>
        </div>
      `;
      document.getElementById('page-home').innerHTML = homePageHtml;
      document.getElementById('start-btn').addEventListener('click', () => {
        setPage(isConsultant ? 'consultant' : 'checklist');
      });
    }

    function renderChecklistPage() {
      const progress = getProgress();
      const byCategory = checklist.reduce((acc, it) => {
        acc[it.category] = acc[it.category] || [];
        acc[it.category].push(it);
        return acc;
      }, {});
    
      const checklistHtml = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2 bg-white p-8 rounded-3xl shadow-xl">
            <h2 class="text-2xl font-semibold">Halal Certificate Checklist</h2>
            <p class="mt-2 text-slate-500">Tick the items you have prepared or upload the required documents. Use sample links as references.</p>
            <div class="mt-6 space-y-6" id="checklist-items-container">
              ${Object.keys(byCategory).map(cat => `
                <div class="p-5 border border-slate-200 rounded-2xl bg-slate-50/50">
                  <h3 class="font-semibold text-lg text-indigo-700">${cat}</h3>
                  <div class="mt-3 grid gap-4">
                    ${byCategory[cat].map(item => `
                      <div class="flex items-start justify-between bg-white p-4 rounded-xl shadow-sm transition-all duration-200 hover:shadow-md">
                        <div class="flex items-start gap-4">
                          <input type="checkbox" id="cb-${item.id}" ${item.done ? 'checked' : ''} class="mt-1 h-5 w-5 rounded-md text-indigo-600 focus:ring-indigo-500 border-slate-300 toggle-checkbox" data-id="${item.id}" />
                          <div class="flex-1">
                            <label for="cb-${item.id}" class="font-medium text-slate-800 cursor-pointer">${item.title}</label>
                            <div class="text-sm text-slate-500 mt-1">
                              ${item.required ? 'Required' : 'Optional'}
                              <span class="mx-1">•</span>
                              <a class="underline text-indigo-500 hover:text-indigo-600" href="${item.sampleLink}" target="_blank" rel="noreferrer">Sample</a>
                            </div>
                            ${item.comment ? `
                              <div class="mt-3 p-3 rounded-lg bg-indigo-50 text-sm text-slate-700 border border-indigo-100">
                                <span class="font-semibold text-indigo-800">Consultant Comment:</span> ${item.comment}
                              </div>
                            ` : ''}
                          </div>
                        </div>
                        ${item.done ? `
                          <div class="text-sm text-green-600 flex-shrink-0 flex items-center gap-1 font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
                              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" />
                            </svg>
                            Completed
                          </div>
                        ` : `
                          <button class="px-4 py-2 bg-indigo-500 text-white rounded-lg text-sm font-medium hover:bg-indigo-600 transition-colors duration-200 transform hover:scale-105 upload-btn" data-id="${item.id}">
                            Upload File
                          </button>
                        `}
                      </div>
                    `).join('')}
                  </div>
                </div>
              `).join('')}
            </div>
            <div class="mt-8 flex gap-4">
              <button id="export-pdf-btn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium shadow-md hover:bg-indigo-700 transition-colors duration-200">Export as PDF</button>
            </div>
          </div>
          <aside class="bg-white p-8 rounded-3xl shadow-xl flex flex-col items-center">
            <h3 class="font-semibold text-lg">Readiness summary</h3>
            <div class="mt-6 w-full flex-1">
              <div class="text-sm text-slate-500">Progress</div>
              <div class="mt-1 text-4xl font-bold text-center">${progress.percent}%</div>
              <div class="w-44 h-44 mt-6 mx-auto">
                <svg viewBox="0 0 100 100" class="w-full h-full">
                  <circle cx="50" cy="50" r="40" fill="none" stroke="#E5E7EB" stroke-width="20" />
                  <path d="M 50 10 A 40 40 0 ${progress.percent > 50 ? 1 : 0} 1 ${50 + 40 * Math.sin(2 * Math.PI * progress.percent / 100)} ${50 - 40 * Math.cos(2 * Math.PI * progress.percent / 100)}" fill="none" stroke="#10B981" stroke-width="20" stroke-linecap="round" />
                </svg>
              </div>
            </div>
            <div class="mt-8 w-full">
              <h4 class="font-semibold text-lg text-slate-700">Quick tips</h4>
              <ul class="mt-2 text-xs text-slate-600 list-disc list-inside space-y-1">
                <li>Collect supplier declarations early.</li>
                <li>Keep scanned copies of SOPs and training records.</li>
                <li>Use HaCeRa to track progress and generate reports for your consultant.</li>
              </ul>
            </div>
          </aside>
        </div>
      `;
      document.getElementById('page-checklist').innerHTML = checklistHtml;
      document.querySelectorAll('.toggle-checkbox').forEach(cb => {
        cb.addEventListener('change', () => toggleDone(parseInt(cb.dataset.id)));
      });
      document.querySelectorAll('.upload-btn').forEach(btn => {
        btn.addEventListener('click', () => handleUpload(parseInt(btn.dataset.id)));
      });
    }

    function renderMyProfilePage() {
      const profile = clientData?.profile || {};
      const profileHtml = `
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div class="bg-white p-8 rounded-3xl shadow-xl">
            <h2 class="text-2xl font-semibold">My Company Profile</h2>
            <p class="mt-2 text-slate-500">Fill in your company details to help your consultant.</p>
            <div class="mt-6 space-y-4">
              <label class="block">
                <span class="text-sm font-medium text-slate-700">Company Name</span>
                <input type="text" id="companyName" value="${profile.companyName || ''}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-colors duration-200" />
              </label>
              <label class="block">
                <span class="text-sm font-medium text-slate-700">Company Type</span>
                <input type="text" id="companyType" value="${profile.companyType || ''}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-colors duration-200" />
              </label>
              <label class="block">
                <span class="text-sm font-medium text-slate-700">Contact Person</span>
                <input type="text" id="contactName" value="${profile.contactName || ''}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-colors duration-200" />
              </label>
              <label class="block">
                <span class="text-sm font-medium text-slate-700">Contact Email</span>
                <input type="email" id="contactEmail" value="${profile.contactEmail || ''}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-colors duration-200" />
              </label>
              <label class="block">
                <span class="text-sm font-medium text-slate-700">Contact Phone</span>
                <input type="tel" id="contactPhone" value="${profile.contactPhone || ''}" class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-colors duration-200" />
              </label>
            </div>
            <div class="mt-8">
              <button id="save-profile-btn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium shadow-md hover:bg-indigo-700 transition-colors duration-200 transform hover:scale-105">Save Profile</button>
            </div>
          </div>
          <div class="bg-white p-8 rounded-3xl shadow-xl">
            <h3 class="text-2xl font-semibold">Profile Preview</h3>
            <div class="mt-4 p-6 border border-slate-200 rounded-xl">
              <div id="preview-companyName" class="text-xl font-medium">${profile.companyName || 'Your Company Name'}</div>
              <div id="preview-companyType" class="text-sm text-slate-500">${profile.companyType || 'Company Type'}</div>
              <div class="mt-6 text-sm text-slate-500 font-medium">Contact Person</div>
              <div id="preview-contactName" class="text-lg font-medium text-slate-800">${profile.contactName || 'N/A'}</div>
              <div id="preview-contactEmail" class="text-sm text-indigo-600 font-medium">${profile.contactEmail || 'N/A'}</div>
              <div id="preview-contactPhone" class="text-sm text-slate-600 font-medium">${profile.contactPhone || 'N/A'}</div>
            </div>
          </div>
        </div>
      `;
      document.getElementById('page-profile').innerHTML = profileHtml;
      
      const inputs = ['companyName', 'companyType', 'contactName', 'contactEmail', 'contactPhone'];
      inputs.forEach(id => {
          document.getElementById(id).addEventListener('input', (e) => {
              const previewEl = document.getElementById(`preview-${id}`);
              if(previewEl) previewEl.innerText = e.target.value || 'N/A';
          });
      });

      document.getElementById('save-profile-btn').addEventListener('click', () => {
        const newProfile = {
          companyName: document.getElementById('companyName').value,
          companyType: document.getElementById('companyType').value,
          contactName: document.getElementById('contactName').value,
          contactEmail: document.getElementById('contactEmail').value,
          contactPhone: document.getElementById('contactPhone').value
        };
        saveProfile(newProfile);
      });
    }
    
    function renderConsultantPage() {
      clients = createSampleClients(); // Reset sample clients
      const tableRows = clients.map(c => `
        <tr class="border-t border-slate-200 transition-all duration-200 hover:bg-slate-50">
          <td class="p-4 font-medium text-slate-800">${c.name}</td>
          <td class="p-4 text-sm text-slate-600">${c.type}</td>
          <td class="p-4">${c.status}</td>
          <td class="p-4 w-64">
            <div class="text-sm">${c.progress}%</div>
            <div class="w-full bg-slate-200 h-2 rounded-full mt-1"><div style="width: ${c.progress}%" class="h-full bg-gradient-to-r from-indigo-500 to-cyan-400"></div></div>
          </td>
          <td class="p-4 text-sm text-slate-500">${c.updated}</td>
          <td class="p-4">
            <button class="open-client-btn px-4 py-2 rounded-lg border border-slate-300 text-slate-700 font-medium hover:bg-slate-100 transition-colors duration-200" data-id="${c.id}">Open</button>
          </td>
        </tr>
      `).join('');
      const consultantHtml = `
        <div class="bg-white p-8 rounded-3xl shadow-xl">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-2xl font-semibold">Consultant Dashboard</h2>
            <div class="text-sm text-slate-500">Manage clients & assessments</div>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full text-left table-auto border-collapse">
              <thead>
                <tr class="text-xs font-semibold text-slate-500 uppercase border-b border-slate-200">
                  <th class="p-4">Client</th>
                  <th class="p-4">Type</th>
                  <th class="p-4">Status</th>
                  <th class="p-4">Progress</th>
                  <th class="p-4">Last update</th>
                  <th class="p-4">Action</th>
                </tr>
              </thead>
              <tbody>
                ${tableRows}
              </tbody>
            </table>
          </div>
          <div class="mt-6 text-xs text-slate-500">Tip: Click a client to open their profile, review assessments, and generate a readiness report.</div>
        </div>
      `;
      document.getElementById('page-consultant-dashboard').innerHTML = consultantHtml;
      document.querySelectorAll('.open-client-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedClientId = btn.dataset.id;
          renderPage('client');
        });
      });
    }

    function renderClientProfilePage() {
      const client = clients.find(c => c.id === selectedClientId);
      if (!client) return;

      const assessmentHtml = client.assessment.map(it => `
        <div class="p-5 border border-slate-200 rounded-2xl bg-slate-50/50">
          <div class="flex items-start justify-between">
            <div class="flex items-start gap-4">
              <input type="checkbox" id="consultant-cb-${it.id}" ${it.done ? 'checked' : ''} class="mt-1 h-5 w-5 rounded-md text-indigo-600 focus:ring-indigo-500 border-slate-300 consultant-toggle-checkbox" data-id="${it.id}" />
              <div class="flex-1">
                <label for="consultant-cb-${it.id}" class="font-medium text-slate-800">${it.title}</label>
                <div class="text-sm text-slate-500 mt-1">
                  ${it.category}
                  <span class="mx-1">•</span>
                  <a class="underline text-indigo-500 hover:text-indigo-600" href="${it.sampleLink}" target="_blank" rel="noreferrer">Sample</a>
                </div>
              </div>
            </div>
            <div class="text-xs text-slate-400 font-medium flex-shrink-0">${it.required ? 'Required' : 'Optional'}</div>
          </div>
          <div class="mt-4">
            <label class="block text-sm font-medium text-slate-700">
              Consultant Comment:
              <textarea
                id="comment-ta-${it.id}"
                data-id="${it.id}"
                rows="2"
                class="mt-1 block w-full rounded-lg border-slate-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 transition-colors duration-200 consultant-comment"
                placeholder="Add comments for the client..."
              >${it.comment || ''}</textarea>
            </label>
          </div>
        </div>
      `).join('');

      const clientProfileHtml = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-2 bg-white p-8 rounded-3xl shadow-xl">
            <div class="flex items-start justify-between">
              <div>
                <h2 class="text-2xl font-semibold">${client.name}</h2>
                <div class="text-sm text-slate-500">${client.type} • ${client.status}</div>
              </div>
              <div class="text-right">
                <div class="text-sm text-slate-500">Progress</div>
                <div class="text-4xl font-bold">${client.progress}%</div>
              </div>
            </div>
            <div class="mt-6">
              <h3 class="font-semibold text-lg">Assessment items</h3>
              <div class="mt-4 space-y-4">
                ${assessmentHtml}
              </div>
            </div>
            <div class="mt-8 flex gap-4">
              <button id="generate-report-btn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg font-medium shadow-md hover:bg-indigo-700 transition-colors duration-200">Generate report</button>
              <button id="message-client-btn" class="px-6 py-3 border border-slate-300 rounded-lg font-medium hover:bg-slate-100 transition-colors duration-200">Message client</button>
            </div>
          </div>
          <aside class="bg-white p-8 rounded-3xl shadow-xl">
            <h3 class="font-semibold text-lg">Summary</h3>
            <div class="mt-4">
              <div class="text-sm text-slate-500">Last updated</div>
              <div class="text-sm font-medium mt-1">${client.updated}</div>
              <div class="mt-6">
                <h4 class="font-semibold text-lg">Notes</h4>
                <div class="mt-2 text-sm text-slate-600">${client.notes || 'No notes yet. Use this area to add consultant observations.'}</div>
              </div>
            </div>
          </aside>
        </div>
      `;
      document.getElementById('page-consultant-client').innerHTML = clientProfileHtml;

      document.querySelectorAll('.consultant-toggle-checkbox').forEach(cb => {
        cb.addEventListener('change', (e) => {
          const id = parseInt(e.target.dataset.id);
          const clientIndex = clients.findIndex(c => c.id === selectedClientId);
          if (clientIndex !== -1) {
            const itemIndex = clients[clientIndex].assessment.findIndex(a => a.id === id);
            if (itemIndex !== -1) {
              clients[clientIndex].assessment[itemIndex].done = e.target.checked;
              clients[clientIndex].progress = Math.round((clients[clientIndex].assessment.filter(x => x.done).length / clients[clientIndex].assessment.length) * 100);
            }
          }
        });
      });

      document.querySelectorAll('.consultant-comment').forEach(ta => {
        ta.addEventListener('change', (e) => {
          const id = parseInt(e.target.dataset.id);
          const clientIndex = clients.findIndex(c => c.id === selectedClientId);
          if (clientIndex !== -1) {
            const itemIndex = clients[clientIndex].assessment.findIndex(a => a.id === id);
            if (itemIndex !== -1) {
              clients[clientIndex].assessment[itemIndex].comment = e.target.value;
            }
          }
        });
      });

      document.getElementById('generate-report-btn').addEventListener('click', () => {
        showModal('Report Generated', 'A readiness report has been successfully generated for this client.');
      });
      document.getElementById('message-client-btn').addEventListener('click', () => {
        showModal('Message Sent', 'A notification has been sent to the client via email.');
      });
    }

    // Data persistence functions
    async function saveAssessment() {
      if (!userId || isConsultant) return;
      try {
        const clientDocRef = doc(db, PRIVATE_DATA_PATH(userId), 'profile');
        const progress = Math.round((checklist.filter(x => x.done).length / checklist.length) * 100);
        await setDoc(clientDocRef, {
          assessment: checklist,
          progress,
          updated: new Date().toLocaleString()
        }, { merge: true });
      } catch (e) {
        console.error("Error saving assessment:", e);
      }
    }

    async function saveProfile(newProfile) {
      if (!userId || isConsultant) return;
      try {
        const clientDocRef = doc(db, PRIVATE_DATA_PATH(userId), 'profile');
        await setDoc(clientDocRef, {
          profile: newProfile,
          updated: new Date().toLocaleString()
        }, { merge: true });
        showModal('Profile Saved', 'Your company profile has been successfully saved.');
      } catch (e) {
        console.error("Error saving profile:", e);
      }
    }

    // Event handlers
    async function handleLogin() {
      if (initialAuthToken) {
          await signInWithCustomToken(auth, initialAuthToken);
      } else {
          await signInAnonymously(auth);
      }
      setPage('home');
    }

    async function handleLogout() {
      try {
        if (auth) {
          await signOut(auth);
        }
        page = 'login';
        isConsultant = false;
        renderPage('login');
      } catch (e) {
        console.error("Logout failed:", e);
      }
    }

    function setPage(newPage) {
      page = newPage;
      renderPage(page);
    }

    function toggleDone(id) {
      const updated = checklist.map(it => it.id === id ? { ...it, done: !it.done } : it);
      checklist = updated;
      saveAssessment();
    }

    function handleUpload(id) {
      const updated = checklist.map(it => it.id === id ? { ...it, done: true } : it);
      checklist = updated;
      saveAssessment();
      showModal('Upload Successful', 'The file has been successfully uploaded and the item is marked as complete. Your consultant will be able to view it shortly.');
    }

    // Initial page load
    window.onload = () => {
      renderLoginPage();
      document.getElementById('logout-button').addEventListener('click', handleLogout);
      document.getElementById('nav-home').addEventListener('click', () => setPage('home'));
      document.getElementById('nav-checklist').addEventListener('click', () => setPage('checklist'));
      document.getElementById('nav-profile').addEventListener('click', () => setPage('profile'));
      document.getElementById('nav-consultant-dashboard').addEventListener('click', () => setPage('consultant'));
    };
  </script>
</body>
</html>
