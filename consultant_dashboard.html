<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Masuk Konsultan - eHalalGAP</title>
    <!-- Favicon Links -->
    <link rel="apple-touch-icon" sizes="180x180" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/favicon-16x16.png">
    <link rel="manifest" href="https://raw.githubusercontent.com/goldigger79/eHalalGAP/main/site.webmanifest">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Chart.js for visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fb; }
        .hero-bg { background-color: #1a4f78; }
        .btn-primary { background-color: #0d9488; transition: background-color 0.3s; }
        .btn-primary:hover { background-color: #0f766e; }
        .btn-secondary { background-color: #e5e7eb; color: #374151; transition: background-color 0.3s; }
        .btn-secondary:hover { background-color: #d1d5db; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 50; overflow-y: auto; padding: 20px; }
        .modal-content { background-color: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 95%; max-width: 1200px; max-height: 95vh; overflow-y: auto; position: relative; }
        
        /* Print-specific styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #modal-report-body, #modal-report-body * {
                visibility: visible;
            }
            #report-modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                overflow: visible;
                display: block !important;
                background-color: white;
                padding: 0;
            }
            .modal-content {
                box-shadow: none;
                border: none;
                padding: 0;
                margin: 0;
                width: 100%;
                max-width: 100%;
                border-radius: 0;
            }
            .print-hidden {
                display: none !important;
            }
            .page-break {
                page-break-before: always;
                break-before: page;
            }
             @page {
                size: A4;
                margin: 2cm;
            }
        }
    </style>
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const APP_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCll1mrRqrAMAUqzdGqSYSyFBiOpb6y_y4",
            authDomain: "ehalalgap.firebaseapp.com",
            projectId: "ehalalgap",
            storageBucket: "ehalalgap.firebasestorage.app",
            appId: "1:687151615169:web:8ff94f1eed2c6d1d5f1840",
            measurementId: "G-6QBXVD6R0R"
        };
        
        const appId = APP_FIREBASE_CONFIG.projectId;
        const firebaseConfig = APP_FIREBASE_CONFIG;
        
        let app, db, auth;
        let selectedClientData = null; // Store data for the selected client

        // --- ALL QUESTIONNAIRE AND SCORING DATA (Copied from client.html) ---
        const flowSteps = [
             { id: 'maklumat', title: '1. Maklumat Perniagaan', type: 'form'},
             { id: 'syarat', title: '2. Syarat Kelayakan', type: 'checklist', questions: ["Adakah perniagaan berdaftar dengan Suruhanjaya Perniagaan Malaysia (SSM)?","Adakah perniagaan Telah beroperasi sepenuhnya sekurang-kurangnya 3 bulan?","Adakah perniagaan Memiliki lesen atau kelulusan daripada PBT?","Jika premis makanan, adakah telah mendapat perakuan FOSIM? *","Jika skim kosmetik, adakah telah mendapat perakuan NPRA? *",]},
             { id: 'kategori', title: '3. Kategori Industri', type: 'selection', options: ['Mikro', 'Kecil', 'Sederhana', 'Besar']},
             { id: 'skim', title: '4. Skim Pensijilan', type: 'selection', options: ['Produk Makanan dan Minuman', 'Produk Kosmetik', 'Produk Farmaseutikal', 'Premis Makanan', 'Produk Barang Gunaan', 'Perkhidmatan Logistik', 'Rumah Sembelihan', 'Pengilangan Kontrak/OEM', 'Produk Peranti Perubatan']},
             { id: 'premis', title: '5. Premis', type: 'qa'},
             { id: 'bahan', title: '6. Bahan Mentah & Peralatan', type: 'qa'},
             { id: 'sanitasi', title: '7. Sanitasi', type: 'qa'},
             { id: 'pekerja', title: '8. Pekerja', type: 'qa'},
             { id: 'dokumentasi', title: '9. Dokumentasi & Rekod', type: 'qa'},
             { id: 'ulasan', title: '10. Ulasan', type: 'textarea'},
             { id: 'result', title: '11. Keputusan & Laporan', type: 'result'}
        ];
        const qaQuestions = {
            premis: ["Adakah premis anda terletak jauh dari dan tidak dicemari oleh ladang babi atau aktiviti pemprosesan tidak halal?", "Adakah premis bebas daripada bahan mentah dan produk tidak halal seperti arak dan daging babi?", "Adakah premis mempunyai mekanisme pengawalan bagi mencegah haiwan peliharaan atau liar, serangga dan haiwan perosak daripada memasuki atau berada di dalam kawasan premis?", "Adakah premis dalam keadaan baik, bersih dan kemas?", "Adakah lantai, dinding, siling, kipas, penghawa dingin, tingkap dan pintu berkeadaan bersih dan tidak menyumbang kepada pencemaran?", "Adakah bekalan air terawat dari Jabatan Bekalan Air (potable water) mencukupi dan dilindungi daripada pencemaran?", "Adakah ruang simpanan bahan mentah dipisahkan daripada ruang simpanan produk siap?", "Adakah terdapat kemudahan sinki untuk basuh tangan yang dilengkapi dengan sabun dan tuala pakai buang/pengering tangan?", "Adakah lantai diperbuat daripada bahan kalis air, tidak menyerap dan mudah dibersihkan?", "Adakah terdapat sistem saliran air yang baik pada lantai pemprosesan?", "Adakah dinding premis licin, kalis air, dan mudah dicuci?", "Adakah siling atau bahagian atas premis direka untuk elak habuk jatuh, kulapuk dan titisan air?", "Adakah pintu premis diperbuat daripada bahan kalis air, mudah dibersihkan, dan ditutup secara kendiri?", "Adakah tingkap yang boleh dibuka dilengkapi dengan jaring/mosquito net untuk elak serangga masuk?","Adakah pencahayaan di kawasan pemprosesan mencukupi dan tidak menyebabkan risiko pencemaran makanan?","Adakah lampu yang berpenutup digunakan di kawasan pemprosesan?","Adakah sistem pengudaraan premis berfungsi baik dan aliran udara bergerak dari kawasan bersih ke kawasan kurang bersih (bukan sebaliknya)?","Adakah bilik air/tandas disediakan dalam jumlah mencukupi?","Adakah bilik air/tandas tidak terus bersambung dengan ruang pemprosesan makanan?","Adakah premis mempunyai stor yang berasingan untuk Bahan mentah?","Adakah premis mempunyai stor yang berasingan untuk Produk siap?","Adakah premis mempunyai stor yang berasingan untuk Bahan kimia/pembersihan?","Adakah premis menyediakan ruang solat kepada pekerja muslim?","Adakah premis menyediakan ruang persalinan kepada pekerja?","Adakah premis menyediakan ruang makan atau rehat kepada pekerja?","Adakah premis menyediakan kemudahan penyimpanan barang peribadi kepada pekerja?","Adakah premis memastikan alat dan unsur penyembahan tidak berada dalam kawasan pemprosesan?","Adakah premis memastikan tempat tinggal pekerja tidak berada dalam kawasan pemprosesan?","Adakah aliran proses pengeluaran makanan dalam premis satu arah (linear flow)?","Adakah terdapat pemisahan kawasan bersih dan kawasan kotor untuk mengelakkan pencemaran?"],
            bahan: ["Adakah semua bahan mentah (termasuk bahan tambahan & bahan pembungkusan primer) mempunyai sijil halal yang sah?","Jika bahan mentah diimport, adakah ia daripada badan pensijilan halal luar negara yang diiktiraf JAKIM?","Adakah rekod pembelian bahan mentah (invois, delivery order) disimpan dan boleh diaudit?","Adakah terdapat sebarang bahan mentah daripada sumber syubhah/diragui?","Adakah bahan mentah halal disimpan berasingan daripada bahan tidak halal/diragui?","Adakah stor bahan mentah dilabel dengan jelas untuk elak kekeliruan (contoh: 'Halal Certified', 'Non-halal', 'Bahan Kimia')?"],
            sanitasi: ["Adakah terdapat sink untuk basuh tangan yang dilengkapi sabun, tisu/pengering automatik, dan air bersih?","Adakah terdapat jadual pembersihan dan sanitasi bertulis yang disediakan dan disemak?","Adakah tong sampah bertutup dan mudah dibersihkan digunakan dalam premis?","Adakah bilik air/tandas Bersih, tidak berbau dan tidak terbuka secara langsung kepada kawasan pemprosesan?","Adakah terdapat sistem kawalan makhluk perosak?"],
            pekerja: ["Adakah perniagaan mempunyai pekerja muslim warganegara?","Adakah pekerja perniagaan telah menerima latihan halal?"],
            dokumentasi: ["Adakah dokumen dan rekod disimpan dengan baik, dikemaskini dan mudah untuk dirujuk?","Adakah perniagaan menyimpan rekod pembelian bahan mentah bersama sijil halal pembekal?"]
        };
        const questionPoints = {
            'syarat': [7, 7, 7, 7, 7], 
            'premis': [7, 7, 5, 3, 7, 7, 7, 7, 7, 7, 7, 7, 7, 5, 5, 7, 7, 5, 7, 7, 7, 7, 7, 7, 5, 3, 7, 5, 7, 7], 
            'bahan': [7, 7, 7, 7, 7, 5], 
            'sanitasi': [5, 5, 3, 5, 5], 
            'pekerja': [7, 5], 
            'dokumentasi': [5, 5] 
        };
        // --------------------------------------------------------------------

        // --- Functions to Calculate Score and Render Report (Adapted from client.html) ---
        const calculateScore = (answers) => {
            const MAX_TOTAL_POINTS = 308;
            let totalPointsScored = 0, totalScoredQuestions = 0, totalAnswered = 0, countYa = 0, countTidak = 0;
            const scoredSections = ['syarat', 'premis', 'bahan', 'sanitasi', 'pekerja', 'dokumentasi'];
            
            scoredSections.forEach(sectionId => {
                const questions = (sectionId === 'syarat') ? flowSteps.find(s => s.id === 'syarat').questions : qaQuestions[sectionId];
                const points = questionPoints[sectionId] || [];
                totalScoredQuestions += questions.length;

                questions.forEach((q, index) => {
                    const answer = answers[`${sectionId}_${index}`];
                    if (answer) {
                        totalAnswered++;
                        let isReadyAnswer = (answer === 'YA');
                        if (sectionId === 'bahan' && (index === 3 || index === 4)) { isReadyAnswer = (answer === 'TIDAK'); }
                        if (isReadyAnswer) { totalPointsScored += (points[index] || 0); countYa++; } else if (answer === 'TIDAK') { countTidak++; }
                    }
                });
            });

            const readinessScore = MAX_TOTAL_POINTS > 0 ? (totalPointsScored / MAX_TOTAL_POINTS) * 100 : 0;
            return { readinessScore, totalPointsScored, totalQuestions: MAX_TOTAL_POINTS, answerBreakdown: { ya: countYa, tidak: countTidak, notAnswered: totalScoredQuestions - totalAnswered } };
        };

        const renderPieChart = (answerBreakdown, canvasId) => {
             const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            const existingChart = Chart.getChart(ctx);
            if (existingChart) { existingChart.destroy(); }
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['YA (Halal Ready)', 'TIDAK (Perlu Tindakan)', 'Belum Dijawab'],
                    datasets: [{
                        data: [answerBreakdown.ya, answerBreakdown.tidak, answerBreakdown.notAnswered],
                        backgroundColor: ['#0d9488', '#dc2626', '#e5e7eb'],
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' }, title: { display: true, text: 'Analisis Jawapan Keseluruhan' } } }
            });
        };
        
        const renderGapsTable = (answers, scoredSections) => {
            let allGaps = [];
            scoredSections.forEach(sectionId => {
                const questions = (sectionId === 'syarat') ? flowSteps.find(s => s.id === 'syarat').questions : qaQuestions[sectionId];
                const points = questionPoints[sectionId] || [];
                const secTitle = flowSteps.find(s => s.id === sectionId)?.title.replace(/^\d+\.\s*/, '') || 'Unknown Section'; 
                
                questions.forEach((q, index) => {
                    const answer = answers[`${sectionId}_${index}`];
                    let isGap = false;
                    if (sectionId === 'bahan' && (index === 3 || index === 4)) {
                        isGap = (answer === 'YA');
                    } else {
                        isGap = (answer === 'TIDAK');
                    }
                    if (isGap) {
                        allGaps.push({ section: secTitle, question: q.replace(/\*/g, '').trim(), pointValue: points[index] || 0 });
                    }
                });
            });

            if (allGaps.length === 0) return '<p class="text-sm text-green-600 p-4 border rounded-lg bg-green-50">Tiada jurang kritikal dikesan.</p>';

            return `
                <div class="overflow-x-auto shadow-md rounded-lg">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Bahagian</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Soalan Jurang (GAP)</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase">Mata Hilang</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            ${allGaps.map(gap => `
                                <tr class="hover:bg-red-50/50">
                                    <td class="px-6 py-4 text-sm font-medium text-red-700">${gap.section}</td>
                                    <td class="px-6 py-4 text-sm text-gray-900">${gap.question}</td>
                                    <td class="px-6 py-4 text-center text-sm font-bold text-red-600">${gap.pointValue}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>`;
        };
        
        const renderReportContent = (client, answers, score) => {
            const progress = score.readinessScore;
            let status, statusColor, recommendation;

            if (progress >= 80) { status = 'Bersedia'; statusColor = 'bg-green-100 text-green-700 border-green-500'; recommendation = 'Perniagaan menunjukkan ketersediaan tinggi.'; } 
            else if (progress >= 60) { status = 'Kurang Bersedia'; statusColor = 'bg-yellow-100 text-yellow-700 border-yellow-500'; recommendation = 'Perniagaan di tahap sederhana. Fokus pada jurang (GAP) yang dikenal pasti.'; } 
            else { status = 'Tidak Bersedia'; statusColor = 'bg-red-100 text-red-700 border-red-500'; recommendation = 'Perniagaan memerlukan penambahbaikan signifikan.'; }

            const clientReview = answers['ulasan_cabaran_utama'];
            const aiSummary = answers.aiSummary || 'Rumusan AI belum dijana oleh klien, atau berlaku ralat semasa penjanaan.';
            const scoredSections = ['syarat', 'premis', 'bahan', 'sanitasi', 'pekerja', 'dokumentasi'];

            return `
                <div id="pdf-content-container" class="p-8 space-y-8 bg-white">
                    <div class="text-center pb-4 border-b border-gray-200">
                        <h1 class="text-3xl font-extrabold text-gray-800">Laporan Semakan Jurang Halal (eHalalGAP)</h1>
                        <p class="text-lg text-gray-500 mt-1">Klien: ${client.clientName || 'Tidak Dinamakan'}</p>
                        <p class="text-sm text-gray-500">ID Klien: ${client.userId}</p>
                    </div>

                    <div class="p-6 rounded-xl shadow-lg border border-gray-100 page-break"><h3 class="text-2xl font-bold text-gray-800 mb-4 text-center">Ringkasan Keputusan</h3><div class="flex flex-col sm:flex-row items-center justify-around text-center space-y-4 sm:space-y-0"><div><p class="text-5xl font-extrabold text-teal-600">${progress.toFixed(0)}%</p><p class="text-xl text-gray-500 mt-1">Peratus Ketersediaan</p></div><div><p class="text-5xl font-extrabold text-gray-800">${score.totalPointsScored}/${score.totalQuestions}</p><p class="text-xl text-gray-500 mt-1">Mata Halal Diperolehi</p></div></div></div>

                    <div class="text-center p-6 rounded-xl border-4 ${statusColor} shadow-md"><p class="text-2xl font-bold">Status: <span class="text-3xl">${status.toUpperCase()}</span></p><p class="mt-4 text-md">${recommendation}</p></div>

                    <div class="p-6 bg-teal-50 rounded-xl shadow-lg border-l-4 border-teal-600 page-break"><h4 class="text-xl font-semibold mb-2">Rumusan Analisis AI</h4><p class="text-xs text-gray-500 italic mb-3">*Ringkasan ini dijana oleh AI dan bertujuan sebagai panduan awal sahaja.</p><div id="ai-summary-content" class="text-base">${aiSummary}</div></div>
                    
                     <div class="p-6 bg-gray-50 rounded-xl shadow-sm border border-gray-200 page-break"><h4 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Maklumat Perniagaan</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-gray-700">${['Nama Perniagaan', 'No SSM (jika ada)', 'Alamat', 'No Telefon', 'Nama Pemilik', 'Jualan tahunan perniagaan', 'Bilangan pekerja keseluruhan'].map(field => {
                                const id = field.toLowerCase().replace(/[^a-z0-9]/g, '_').replace(/_+/g, '_'); 
                                return `<p><strong>${field}:</strong> ${answers[id] || '- Tidak diisi -'}</p>`;
                            }).join('')}</div></div>

                    ${clientReview ? `
                        <div class="p-6 bg-gray-50 rounded-xl shadow-sm border border-gray-200 page-break"><h4 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">Ulasan Cabaran oleh Klien</h4><p class="text-sm text-gray-700 whitespace-pre-wrap">${clientReview}</p></div>` : ''
                    }

                    <div class="p-6 bg-white rounded-xl shadow-lg page-break"><h4 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2 text-center">Analisis Jawapan Keseluruhan</h4><div class="flex justify-center w-full max-w-lg mx-auto"><canvas id="modalReportPieChart" width="400" height="400"></canvas></div></div>
                    
                    <div class="p-6 bg-white rounded-xl shadow-lg border-t-4 border-red-500 page-break"><h4 class="text-xl font-bold text-red-700 mb-4 border-b pb-2">Jurang Pematuhan Kritikal</h4>${renderGapsTable(answers, scoredSections)}</div>

                    <div class="p-6 bg-white rounded-xl shadow-lg page-break"><h4 class="text-xl font-semibold text-gray-800 mb-6 border-b pb-2">Analisis Mengikut Bahagian</h4>${scoredSections.map(sectionId => {
                            const questions = (sectionId === 'syarat') ? flowSteps.find(s => s.id === 'syarat').questions : qaQuestions[sectionId];
                            const points = questionPoints[sectionId] || [];
                            let secMaxPoints = points.reduce((a, b) => a + b, 0);
                            let secPointsScored = 0;
                            questions.forEach((q, index) => {
                                const answer = answers[`${sectionId}_${index}`];
                                let isReadyAnswer = (answer === 'YA');
                                if (sectionId === 'bahan' && (index === 3 || index === 4)) { isReadyAnswer = (answer === 'TIDAK'); }
                                if (isReadyAnswer) { secPointsScored += points[index]; }
                            });
                            const secPercentage = secMaxPoints > 0 ? (secPointsScored / secMaxPoints) * 100 : 0;
                            const secTitle = flowSteps.find(s => s.id === sectionId)?.title.replace(/^\d+\.\s*/, '') || sectionId;
                            const barColor = secPercentage >= 80 ? 'bg-green-500' : secPercentage >= 60 ? 'bg-yellow-500' : 'bg-red-500';
                            return `
                                <div class="mb-6 border-b pb-4">
                                    <h5 class="text-lg font-bold text-gray-800">${secTitle}</h5>
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-sm font-medium">Skor: ${secPointsScored}/${secMaxPoints}</span>
                                        <span class="text-lg font-bold">${secPercentage.toFixed(0)}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-3"><div class="${barColor} h-3 rounded-full" style="width: ${secPercentage.toFixed(0)}%"></div></div>
                                </div>`;
                        }).join('')}</div>

                    <div class="text-xs text-gray-500 text-center pt-4 border-t">&copy; Hak Cipta ACE UniKL MICET 2025.</div>
                </div>`;
        };

        const downloadPDF = () => {
            if (!selectedClientData) {
                alert("Sila pilih klien dan jana laporan terlebih dahulu.");
                return;
            }
            const { client, answers, score } = selectedClientData;
            
            // Re-render content specifically for PDF generation to ensure chart is included
            const element = document.createElement('div');
            element.innerHTML = renderReportContent(client, answers, score);
            
            // Append to body temporarily to render chart
            document.body.appendChild(element);
            const chartCanvas = element.querySelector('#modalReportPieChart');
            renderPieChart(score.answerBreakdown, chartCanvas.id);

            const filename = `Laporan_eHalalGAP_${(client.clientName || 'Klien').replace(/\s+/g, '_')}_${new Date().toISOString().slice(0, 10)}.pdf`;
            const opt = { margin: 0.5, filename, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' } };
            
            // Add a small delay for chart to render before generating PDF
            setTimeout(() => {
                html2pdf().set(opt).from(element).save().then(() => {
                    document.body.removeChild(element); // Clean up the temporary element
                });
            }, 500);
        };
        window.downloadPDF = downloadPDF;
        
        window.viewReport = async (userId) => {
            const reportBody = document.getElementById('modal-report-body');
            reportBody.innerHTML = '<p class="text-center p-8">Memuatkan data klien...</p>';
            toggleModal(true);

            try {
                const docRef = doc(db, `/artifacts/${appId}/users/${userId}/halal_readiness_assessment/data`);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) throw new Error("Dokumen data terperinci klien tidak ditemui.");
                const answers = docSnap.data().answers || {};

                const clientSummaryRef = doc(db, `/artifacts/${appId}/public/data/clients/${userId}`);
                const clientSummarySnap = await getDoc(clientSummaryRef);
                if (!clientSummarySnap.exists()) throw new Error("Dokumen ringkasan klien tidak ditemui.");
                const client = clientSummarySnap.data();

                const score = calculateScore(answers);
                selectedClientData = { client, answers, score };
                
                // Render the full report structure
                reportBody.innerHTML = renderReportContent(client, answers, score);

                // Render pie chart inside the now-visible modal
                setTimeout(() => renderPieChart(score.answerBreakdown, 'modalReportPieChart'), 100);

            } catch (error) {
                console.error("Gagal memuatkan laporan klien:", error);
                let detailedErrorMessage = `Gagal memuatkan laporan: ${error.message}.`;
                if (error.code === 'permission-denied' || error.message.includes("Missing or insufficient permissions")) {
                    detailedErrorMessage += `<br><br><div class='mt-4 p-4 bg-orange-100 border-l-4 border-orange-500 text-orange-700 text-left text-sm'>
                        <p class='font-bold'>Nota Pembangun:</p>
                        <p class='mt-2'>Ralat ini berlaku kerana <b>Peraturan Keselamatan (Security Rules) Firebase</b> tidak membenarkan akaun konsultan membaca data peribadi klien.</p>
                        <p class='mt-2'>Untuk membetulkannya, sila pergi ke papan pemuka Firebase anda (Firestore Database -> Rules) dan pastikan peraturan untuk laluan data klien membenarkan akses baca untuk akaun konsultan yang telah disahkan.</p>
                        </div>`;
                }
                reportBody.innerHTML = `<div class="p-8 text-red-600 text-center">${detailedErrorMessage}</div>`;
            }
        };

        const toggleModal = (show) => {
            document.getElementById('report-modal').style.display = show ? 'flex' : 'none';
        };
        window.toggleModal = toggleModal;

        const showLogin = () => {
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'flex';
        };

        const showDashboard = () => {
            document.getElementById('loading-container').style.display = 'none';
            document.getElementById('login-container').style.display = 'none';
            document.getElementById('dashboard-container').style.display = 'block';
        };
        
        window.handleConsultantLogin = async () => {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorMessage = document.getElementById('auth-error-message');
            errorMessage.textContent = '';

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Login failed:", error);
                if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                    errorMessage.textContent = 'Emel atau kata laluan tidak sah.';
                } else {
                    errorMessage.textContent = 'Ralat log masuk. Sila cuba lagi.';
                }
            }
        };
        
        window.logoutConsultant = async () => {
            await signOut(auth);
        };

        window.onload = () => {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            
            const consultantUIDs = ["7XtS5IWBTpgKryjAvONtXALd8R03", "A2nVUfDEVkhQPyTf8tUkCoXmQeJ3"];

            onAuthStateChanged(auth, (user) => {
                if (user && consultantUIDs.includes(user.uid)) {
                    showDashboard();
                    loadClients();
                } else {
                    if(user) { signOut(auth); }
                    showLogin();
                }
            });
        };

        function loadClients() {
            const clientsCollection = collection(db, `/artifacts/${appId}/public/data/clients`);
            const q = query(clientsCollection);

            onSnapshot(q, (snapshot) => {
                const clientList = snapshot.docs.map(doc => doc.data());
                const tableBody = document.getElementById('client-list-body');
                const loadingRow = document.getElementById('loading-row');
                
                if (clientList.length === 0) {
                    loadingRow.innerHTML = '<td colspan="5" class="text-center p-4">Tiada klien yang berdaftar lagi.</td>';
                    return;
                }

                loadingRow.style.display = 'none';
                tableBody.innerHTML = clientList.map(client => `
                    <tr class="hover:bg-gray-50">
                        <td class="p-4 font-medium">${client.clientName || 'Client Baru'}</td>
                        <td class="p-4 text-xs text-gray-600">${client.userId}</td>
                        <td class="p-4 font-bold text-teal-700">${parseFloat(client.readinessScore).toFixed(0)}%</td>
                        <td class="p-4 text-sm">${new Date(client.lastUpdated).toLocaleString('ms-MY')}</td>
                        <td class="p-4 space-x-2">
                            <button onclick="viewReport('${client.userId}')" class="btn-primary text-white px-3 py-1 rounded-md text-sm">Lihat Laporan</button>
                        </td>
                    </tr>
                `).join('');
            }, (error) => {
                console.error("Gagal memuatkan senarai klien: ", error);
                 document.getElementById('loading-row').innerHTML = '<td colspan="5" class="text-center p-4 text-red-600">Ralat memuatkan data klien.</td>';
            });
        }
    </script>
</head>
<body>
    <div id="loading-container" class="h-screen flex items-center justify-center">
        <div class="animate-spin rounded-full h-16 w-16 border-b-2 border-teal-500"></div>
        <p class="ml-4 text-teal-600">Mengesahkan Akses...</p>
    </div>

    <div id="login-container" class="h-screen items-center justify-center p-4" style="display: none;">
        <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-md">
            <h1 class="text-3xl font-bold mb-6 text-center text-gray-800">Log Masuk Konsultan</h1>
            <div class="space-y-4">
                <input type="email" id="email" placeholder="Alamat Emel" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" />
                <input type="password" id="password" placeholder="Kata Laluan" required class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500" />
                <p id="auth-error-message" class="text-sm text-red-500 text-center h-4"></p>
                <button onclick="handleConsultantLogin()" class="w-full btn-primary text-white py-3 rounded-xl font-semibold shadow-md hover:shadow-lg">
                    Log Masuk
                </button>
            </div>
             <p class="mt-6 text-xs text-center">
                <a href="index.html" class="text-teal-600 hover:text-teal-800 font-medium">
                    &larr; Kembali ke Halaman Utama
                </a>
            </p>
        </div>
    </div>
    
    <div id="dashboard-container" class="min-h-screen flex-col" style="display: none;">
        <!-- Header -->
        <header class="hero-bg py-4 px-4 shadow-lg">
            <div class="max-w-7xl mx-auto text-white flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold">Papan Pemuka Konsultan eHalalGAP</h1>
                    <p class="text-sm text-gray-200">Senarai Klien & Kemajuan Penilaian</p>
                </div>
                <button onclick="logoutConsultant()" class="bg-red-500 text-white hover:bg-red-600 px-4 py-2 rounded-lg text-sm font-semibold">Log Keluar</button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow max-w-7xl mx-auto py-8 w-full px-4 sm:px-6 lg:px-8">
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Senarai Klien Berdaftar</h2>
            
            <div class="bg-white rounded-xl shadow-2xl overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Nama Perniagaan</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">ID Klien</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Skor Ketersediaan</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Terakhir Dikemaskini</th>
                                <th class="p-4 text-left text-xs font-medium text-gray-500 uppercase">Tindakan</th>
                            </tr>
                        </thead>
                        <tbody id="client-list-body" class="divide-y divide-gray-200">
                            <tr id="loading-row">
                                <td colspan="5" class="text-center p-8">
                                    <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-teal-500 mx-auto"></div>
                                    <p class="mt-2">Memuatkan senarai klien...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
        
        <!-- Footer -->
        <footer class="bg-gray-800 text-white p-4">
            <div class="max-w-7xl mx-auto text-center text-sm">
                <p>&copy; Hak Cipta ACE UniKL MICET 2025.</p>
            </div>
        </footer>
    </div>

    <!-- Report Preview Modal -->
    <div id="report-modal" class="modal">
        <div class="modal-content">
            <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center rounded-t-xl z-10 print-hidden">
                <h2 class="text-2xl font-bold text-gray-800">Laporan Penuh Klien</h2>
                <button onclick="window.toggleModal(false)" class="text-gray-500 hover:text-gray-800 text-3xl leading-none">&times;</button>
            </div>
            <div id="modal-report-body"></div>
            <div class="sticky bottom-0 bg-gray-50 border-t p-4 flex justify-center space-x-4 rounded-b-xl z-10 print-hidden">
                <button onclick="window.toggleModal(false)" class="btn-secondary px-6 py-2 rounded-xl">Tutup</button>
                <button onclick="window.printReport()" class="btn-primary text-white px-6 py-2 rounded-xl">Cetak Laporan</button>
            </div>
        </div>
    </div>
</body>
</html>

